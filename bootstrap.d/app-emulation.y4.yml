sources:
  - name: qemu
    subdir: 'ports'
    git: 'https://github.com/qemu/qemu.git'
    tag: 'v9.2.3'
    version: '9.2.3'

  - name: wine
    subdir: 'ports'
    git: 'https://gitlab.winehq.org/wine/wine.git'
    tag: 'wine-10.12'
    version: '10.12'
    tools_required:
      - host-automake-v1.15
    regenerate:
      - args: ['cp',
          '@BUILD_ROOT@/tools/host-automake-v1.15/share/automake-1.15/config.sub',
          '@THIS_SOURCE_DIR@/tools/']

tools:
  - name: host-qemu
    labels: [aarch64, riscv64, not-on-xbbs]
    architecture: noarch
    containerless: true
    from_source: qemu
    revision: 2
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--prefix=@PREFIX@'
        - '--target-list=x86_64-softmmu,aarch64-softmmu,riscv64-softmmu'
        - '--disable-werror'
        - '--extra-cflags=-march=native'
        - '--enable-opengl'
        - '--enable-virglrenderer'
        - '--enable-gtk'
        - '--enable-sdl'
        - '--enable-trace-backends=log'
        environ:
          CFLAGS: '-Wno-int-conversion'
    compile:
      - args: ['ninja']
    install:
      - args: ['ninja', 'install']

  - name: host-wine-tools
    architecture: noarch
    from_source: wine
    tools_required:
      - host-freetype
      - host-pkg-config
      - virtual: pkgconfig-for-host
        program_name: host-pkg-config
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--prefix=@PREFIX@'
        - '--enable-win64'
        - '--disable-tests'
        - '--disable-win16'
        - '--without-alsa'
        - '--without-capi'
        - '--without-cups'
        - '--without-dbus'
        - '--without-gettext'
        - '--without-gphoto'
        - '--without-gssapi'
        - '--without-gstreamer'
        - '--without-krb5'
        - '--without-mingw'
        - '--without-netapi'
        - '--without-opencl'
        - '--without-osmesa'
        - '--without-oss'
        - '--without-pcap'
        - '--without-pulse'
        - '--without-sane'
        - '--without-sdl'
        - '--without-unwind'
        - '--without-usb'
        - '--without-v4l2'
        - '--without-vulkan'
        - '--without-xcomposite'
        - '--without-xinerama'
        - '--without-xinput2'
        - '--without-xshape'
        - '--without-xcursor'
        - '--without-xinput'
        - '--without-xfixes'
        - '--without-xrandr'
        - '--without-xrender'
        - '--without-xxf86vm'
        - '--without-xshm'
        - '--without-gnutls'
        - '--without-opengl'
        - '--without-udev'
        environ:
          PKG_CONFIG_LIBDIR: '@BUILD_ROOT@/tools/host-freetype/lib/pkgconfig'
    compile:
      - args: ['make', '-j@PARALLELISM@']
    install:
      - args: ['make', 'install', '-j@PARALLELISM@']

packages:
  - name: qemu
    architecture: '@OPTION:arch@'
    metadata:
      summary: A generic and open source machine emulator and virtualizer
      description: A generic and open source machine emulator and virtualizer
      spdx: 'GPL-2.0'
      website: 'https://qemu.org/'
      maintainer: 'Kacper Słomiński <qookie@managarm.org>'
      categories: ['app-emulation']
    from_source: qemu
    tools_required:
      - host-pkg-config
      - system-gcc
      - virtual: pkgconfig-for-target
        triple: "@OPTION:arch-triple@"
    pkgs_required:
      - mlibc
      - glib
      - sdl2
      - pcre
      - libiconv
      - libxml
      - zstd
      - libpng
      - pixman
      - ncurses
      - nettle
      - libtasn
      - gnutls
      - libgcrypt
      - libusb
      - curl
    revision: 2
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--cross-prefix=@OPTION:arch-triple@-'
        - '--host=@OPTION:arch-triple@'
        - '--prefix=/usr'
        - '--target-list=i386-softmmu,x86_64-softmmu,aarch64-softmmu,riscv32-softmmu,riscv64-softmmu'
        - '--disable-slirp'
        - '--with-coroutine=sigaltstack'
        - '--disable-auth-pam'
        isolate_network: false
        environ:
          PKG_CONFIG_LIBDIR: '@SYSROOT_DIR@/usr/lib/pkgconfig:@SYSROOT_DIR@/usr/share/pkgconfig'
    build:
      - args: ['ninja']
      - args: ['ninja', 'install']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'
        quiet: true

  - name: wine
    architecture: '@OPTION:arch@'
    metadata:
      summary: Free implementation of Windows(tm) on Unix, without external patchsets
      description: Free implementation of Windows(tm) on Unix, without external patchsets
      spdx: 'LGPL-2.1-or-later BSD-2 IJG MIT OPENLDAP ZLIB gsm libpng2 libtiff'
      website: 'https://www.winehq.org'
      maintainer: 'Qwinci <qwinci222@gmail.com>'
      categories: ['app-emulation']
    from_source: wine
    tools_required:
      - host-pkg-config
      - system-gcc
      - host-llvm-toolchain
      - virtual: pkgconfig-for-target
        triple: '@OPTION:arch-triple@'
      - host-wine-tools
    pkgs_required:
      - mlibc
      - libxcursor
      - libxfixes
      - libxi
      - libxrandr
      - libxrender
      - libxxf86vm
      - libxshmfence
      - libx11
      - libxext
      - mesa
      - fontconfig
      - sdl2
      - gnutls
      - freetype
      - glib
      - gst-plugins-base
      - gstreamer
      - systemd
      - xorg-proto
      - managarm-system
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=@OPTION:arch-triple@'
        - '--prefix=/usr'
        - '--disable-tests'
        - '--enable-archs=@OPTION:arch@'
        - '--enable-tools=yes'
        - '--enable-win64' # We want 64 bit after all
        - '--disable-win16' # Don't care about 16 bit
        - '--without-alsa'
        - '--without-capi'
        - '--without-cups'
        - '--without-dbus'
        - '--without-gettext'
        - '--without-gphoto'
        - '--without-gssapi'
        - '--without-krb5'
        - '--without-mingw' # Might want this later, but for now we don't have it
        - '--without-netapi'
        - '--without-opencl'
        - '--without-oss'
        - '--without-pcap'
        - '--without-pulse'
        - '--without-sane'
        - '--without-unwind'
        - '--without-usb'
        - '--without-v4l2'
        - '--without-vulkan'
        - '--without-xcomposite'
        - '--without-xinerama'
        - '--with-x'
        - '--with-wine-tools=@BUILD_ROOT@/tool-builds/host-wine-tools/'
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'install', '-j@PARALLELISM@']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'
        quiet: true
