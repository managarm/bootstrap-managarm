!<tag:y4.managarm.org:preamble>
import:
  - !managarm
---
sources:
  - name: librsvg
    subdir: 'ports'
    git: 'https://gitlab.gnome.org/GNOME/librsvg.git'
    tag: '2.61.2'
    version: '2.61.2'

packages:
  - name: gsettings-desktop-schemas
    architecture: '@OPTION:arch@'
    metadata:
      summary: Collection of GSettings schemas for GNOME desktop
      description: This package contains a collection of GSettings schemas for settings shared by various components of a GNOME Desktop.
      spdx: 'LGPL-2.1-or-later'
      website: 'https://gitlab.gnome.org/GNOME/gsettings-desktop-schemas'
      maintainer: "Dennis Bonke <dennis@managarm.org>"
      categories: ['gnome-base']
    source:
      subdir: ports
      git: 'https://gitlab.gnome.org/GNOME/gsettings-desktop-schemas.git'
      tag: '48.0'
      version: '48.0'
    tools_required:
      - system-gcc
      - !managarm::arch_dep
        arch: [x86_64]
        item: host-mlibc
      - !managarm::arch_dep
        arch: [x86_64]
        item: host-gobject-introspection
      - host-libtool
      - host-pkg-config
      - virtual: pkgconfig-for-target
        triple: "@OPTION:arch-triple@"
    pkgs_required:
      - mlibc
      - glib
    revision: 3
    configure:
      - args: |
              sed -i -r 's:"(/system):"/org/gnome\1:g' @THIS_SOURCE_DIR@/schemas/*.in
      - args:
        - 'meson'
        - 'setup'
        - '--cross-file'
        - '@SOURCE_ROOT@/scripts/meson-@OPTION:arch-triple@.cross-file'
        - '--prefix=/usr'
        - !managarm::arch_ite
          arch: [x86_64]
          # Disabled on all architectures for now
          then: '-Dintrospection=false'
          else: '-Dintrospection=false'
        - '@THIS_SOURCE_DIR@'
    build:
      - args: ['ninja']
      - args: ['ninja', 'install']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'
    scripts:
        post_install:
          - args: 'glib-compile-schemas /usr/share/glib-2.0/schemas'

  - name: librsvg
    architecture: '@OPTION:arch@'
    metadata:
      summary: Scalable Vector Graphics (SVG) rendering library
      description: This package provides libraries used for rendering SVG images.
      spdx: 'LGPL-2.1-or-later'
      website: 'https://wiki.gnome.org/Projects/LibRsvg'
      maintainer: "Dennis Bonke <dennis@managarm.org>"
      categories: ['gnome-base']
    from_source: librsvg
    tools_required:
      - system-gcc
      - host-pkg-config
      - wayland-scanner
      - virtual: pkgconfig-for-target
        triple: "@OPTION:arch-triple@"
      - virtual: pkgconfig-for-host
        program_name: host-pkg-config
      - !managarm::arch_dep
        arch: [x86_64]
        item: host-mlibc
      - !managarm::arch_dep
        arch: [x86_64]
        item: host-gobject-introspection
      - host-python
      - host-glib
      # - host-vala   # Vala is currently disabled
      - host-cargo
      - host-cargo-cbuild
    pkgs_required:
      - mlibc
      - glib
      - cairo
      - pango
      - harfbuzz
      - gdk-pixbuf
      - libxml
      - !managarm::arch_dep
        arch: [x86_64]
        item: gobject-introspection
    sources_required:
      - rust-patched-libs
    revision: 1
    configure:
      - args: ['@SOURCE_ROOT@/scripts/cargo-inject-patches.py', '@THIS_SOURCE_DIR@/Cargo.toml']
        isolate_network: false
      - args:
        - 'meson'
        - 'setup'
        - '--cross-file'
        - '@SOURCE_ROOT@/scripts/meson-@OPTION:arch-triple@-goi.cross-file'
        - '--prefix=/usr'
        - '--buildtype=release'
        - '--wrap-mode=nodownload'
        - !managarm::arch_ite
          arch: [x86_64]
          then: '-Dintrospection=enabled'
          else: '-Dintrospection=disabled'
        - '-Davif=disabled'
        - '-Dpixbuf=enabled'
        - '-Dpixbuf-loader=disabled' # We build the pixbuf loader separately
        - '-Ddocs=disabled'
        - '-Dtests=false'
        - '-Dvala=disabled' # Investigate later
        - '-Dtriplet=@OPTION:rust-arch@-unknown-managarm-mlibc'
        - '@THIS_SOURCE_DIR@'
        environ:
          # Same as below
          RUN_WRAPPER_LD_LIBRARY_PATH: '@BUILD_ROOT@/tools/host-mlibc/lib:@SYSROOT_DIR@/usr/lib:@SYSROOT_DIR@/usr/lib64:@THIS_BUILD_DIR@/girepository'
          RUN_WRAPPER_INTERP: '@BUILD_ROOT@/tools/host-mlibc/lib/ld.so'
    build:
      - args: ['ninja']
        isolate_network: false
        environ:
          # Library path for our run-wrapper that allows it to load managarm libraries
          RUN_WRAPPER_LD_LIBRARY_PATH: '@BUILD_ROOT@/tools/host-mlibc/lib:@SYSROOT_DIR@/usr/lib:@SYSROOT_DIR@/usr/lib64:@THIS_BUILD_DIR@/girepository'
          # Similar to above, but using a nasty (but working) hack lets us use a Linux mlibc build to execute an
          # executable that was cross-compiled for managarm
          RUN_WRAPPER_INTERP: '@BUILD_ROOT@/tools/host-mlibc/lib/ld.so'
          # This is a custom environment variable which tells g-ir-scanner what to use instead of ldd
          # We point it at our native ldd-wrapper that's installed as part of host-gobject-introspection
          GI_LDD_WRAPPER: ldd-wrapper
          # This tells g-ir-scanner what program should be used for "cross-launching" the executables it builds
          GI_CROSS_LAUNCHER: run-wrapper
          # Path to the introspection data installed by other packages
          GI_GIR_PATH: '@SYSROOT_DIR@/usr/share/gir-1.0'
      - args: ['ninja', 'install']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'
          # Library path for our run-wrapper that allows it to load managarm libraries
          RUN_WRAPPER_LD_LIBRARY_PATH: '@BUILD_ROOT@/tools/host-mlibc/lib:@SYSROOT_DIR@/usr/lib:@SYSROOT_DIR@/usr/lib64:@THIS_BUILD_DIR@/girepository'
          # Similar to above, but using a nasty (but working) hack lets us use a Linux mlibc build to execute an
          # executable that was cross-compiled for managarm
          RUN_WRAPPER_INTERP: '@BUILD_ROOT@/tools/host-mlibc/lib/ld.so'
          # This is a custom environment variable which tells g-ir-scanner what to use instead of ldd
          # We point it at our native ldd-wrapper that's installed as part of host-gobject-introspection
          GI_LDD_WRAPPER: ldd-wrapper
          # This tells g-ir-scanner what program should be used for "cross-launching" the executables it builds
          GI_CROSS_LAUNCHER: run-wrapper
          # Path to the introspection data installed by other packages
          GI_GIR_PATH: '@SYSROOT_DIR@/usr/share/gir-1.0'

  - name: gdk-pixbuf-svg
    architecture: '@OPTION:arch@'
    metadata:
      summary: Scalable Vector Graphics (SVG) rendering library - pixbuf loader
      description: This package provides libraries used for rendering SVG images - pixbuf loader.
      spdx: 'LGPL-2.1-or-later'
      website: 'https://wiki.gnome.org/Projects/LibRsvg'
      maintainer: "Dennis Bonke <dennis@managarm.org>"
      categories: ['gnome-base']
    from_source: librsvg
    tools_required:
      - system-gcc
      - host-pkg-config
      - wayland-scanner
      - virtual: pkgconfig-for-target
        triple: "@OPTION:arch-triple@"
      - virtual: pkgconfig-for-host
        program_name: host-pkg-config
      - !managarm::arch_dep
        arch: [x86_64]
        item: host-mlibc
      - !managarm::arch_dep
        arch: [x86_64]
        item: host-gobject-introspection
      - host-python
      - host-glib
      # - host-vala   # Vala is currently disabled
      - host-cargo
      - host-cargo-cbuild
    pkgs_required:
      - mlibc
      - glib
      - cairo
      - pango
      - harfbuzz
      - gdk-pixbuf
      - libxml
      - librsvg
      - !managarm::arch_dep
        arch: [x86_64]
        item: gobject-introspection
    sources_required:
      - rust-patched-libs
    revision: 1
    configure:
      - args: ['@SOURCE_ROOT@/scripts/cargo-inject-patches.py', '@THIS_SOURCE_DIR@/Cargo.toml']
        isolate_network: false
      - args:
        - 'meson'
        - 'setup'
        - '--cross-file'
        - '@SOURCE_ROOT@/scripts/meson-@OPTION:arch-triple@-goi.cross-file'
        - '--prefix=/usr'
        - '--buildtype=release'
        - '--wrap-mode=nodownload'
        - !managarm::arch_ite
          arch: [x86_64]
          then: '-Dintrospection=enabled'
          else: '-Dintrospection=disabled'
        - '-Davif=disabled'
        - '-Dpixbuf=enabled'
        - '-Dpixbuf-loader=enabled'
        - '-Ddocs=disabled'
        - '-Dtests=false'
        - '-Dvala=disabled' # Investigate later
        - '-Dtriplet=@OPTION:rust-arch@-unknown-managarm-mlibc'
        - '@THIS_SOURCE_DIR@'
        environ:
          # Same as below
          RUN_WRAPPER_LD_LIBRARY_PATH: '@BUILD_ROOT@/tools/host-mlibc/lib:@SYSROOT_DIR@/usr/lib:@SYSROOT_DIR@/usr/lib64:@THIS_BUILD_DIR@/girepository'
          RUN_WRAPPER_INTERP: '@BUILD_ROOT@/tools/host-mlibc/lib/ld.so'
    build:
      - args: ['ninja']
        isolate_network: false
        environ:
          # Library path for our run-wrapper that allows it to load managarm libraries
          RUN_WRAPPER_LD_LIBRARY_PATH: '@BUILD_ROOT@/tools/host-mlibc/lib:@SYSROOT_DIR@/usr/lib:@SYSROOT_DIR@/usr/lib64:@THIS_BUILD_DIR@/girepository'
          # Similar to above, but using a nasty (but working) hack lets us use a Linux mlibc build to execute an
          # executable that was cross-compiled for managarm
          RUN_WRAPPER_INTERP: '@BUILD_ROOT@/tools/host-mlibc/lib/ld.so'
          # This is a custom environment variable which tells g-ir-scanner what to use instead of ldd
          # We point it at our native ldd-wrapper that's installed as part of host-gobject-introspection
          GI_LDD_WRAPPER: ldd-wrapper
          # This tells g-ir-scanner what program should be used for "cross-launching" the executables it builds
          GI_CROSS_LAUNCHER: run-wrapper
          # Path to the introspection data installed by other packages
          GI_GIR_PATH: '@SYSROOT_DIR@/usr/share/gir-1.0'
      - args: ['ninja', 'install']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'
          # Library path for our run-wrapper that allows it to load managarm libraries
          RUN_WRAPPER_LD_LIBRARY_PATH: '@BUILD_ROOT@/tools/host-mlibc/lib:@SYSROOT_DIR@/usr/lib:@SYSROOT_DIR@/usr/lib64:@THIS_BUILD_DIR@/girepository'
          # Similar to above, but using a nasty (but working) hack lets us use a Linux mlibc build to execute an
          # executable that was cross-compiled for managarm
          RUN_WRAPPER_INTERP: '@BUILD_ROOT@/tools/host-mlibc/lib/ld.so'
          # This is a custom environment variable which tells g-ir-scanner what to use instead of ldd
          # We point it at our native ldd-wrapper that's installed as part of host-gobject-introspection
          GI_LDD_WRAPPER: ldd-wrapper
          # This tells g-ir-scanner what program should be used for "cross-launching" the executables it builds
          GI_CROSS_LAUNCHER: run-wrapper
          # Path to the introspection data installed by other packages
          GI_GIR_PATH: '@SYSROOT_DIR@/usr/share/gir-1.0'
      # Remove items installed by librsvg
      - args: |
              rm -rfv @THIS_COLLECT_DIR@/usr/lib/girepository-1.0
              rm -rfv @THIS_COLLECT_DIR@/usr/lib/pkgconfig
              rm -rfv @THIS_COLLECT_DIR@/usr/lib/*.so*
              rm -rfv @THIS_COLLECT_DIR@/usr/include
              rm -rfv @THIS_COLLECT_DIR@/usr/share/gir-1.0
              rm -rfv @THIS_COLLECT_DIR@/usr/bin
