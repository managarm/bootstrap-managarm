!<tag:y4.managarm.org:preamble>
import:
  - !managarm
---
packages:
  - name: gnome-calculator
    architecture: '@OPTION:arch@'
    metadata:
      summary: A calculator application for GNOME
      description: This package provides a powerful graphical calculator with financial, logical and scientific modes. It uses a multiple precision package to do its arithmetic to give a high degree of accuracy.
      spdx: 'GPL-3.0-or-later'
      website: 'https://wiki.gnome.org/Apps/Calculator'
      maintainer: "Dennis Bonke <dennis@managarm.org>"
      categories: ['gnome-extra']
    source:
      subdir: 'ports'
      git: 'https://gitlab.gnome.org/GNOME/gnome-calculator.git'
      tag: '46.3'
      version: '46.3'
    tools_required:
      - system-gcc
      - wayland-scanner
      - host-pkg-config
      - virtual: pkgconfig-for-target
        triple: "@OPTION:arch-triple@"
      - host-vala
      - host-glib
      - !managarm::arch_dep
        arch: [x86_64]
        item: host-mlibc
      - !managarm::arch_dep
        arch: [x86_64]
        item: host-gobject-introspection
    pkgs_required:
      - mlibc
      - glib
      - gtk4
      - libxml
      - libsoup3
      - libgee
      - mpfr
      - mpc
      - libadwaita
      - gtksourceview5
    revision: 3
    configure:
      - args:
        - 'meson'
        - 'setup'
        - '--cross-file'
        - '@SOURCE_ROOT@/scripts/meson-@OPTION:arch-triple@.cross-file'
        - '--native-file'
        - '@SOURCE_ROOT@/scripts/meson.native-file'
        - '--prefix=/usr'
        - '--buildtype=release'
        - '--wrap-mode=nodownload'
        - '-Dgcalc=true'
        - '-Dgci=true'
        - '-Dapp=true'
        - '-Ddoc=false'
        - '@THIS_SOURCE_DIR@'
        environ:
          # Same as below
          RUN_WRAPPER_LD_LIBRARY_PATH: '@BUILD_ROOT@/tools/host-mlibc/lib:@SYSROOT_DIR@/usr/lib:@SYSROOT_DIR@/usr/lib64:@THIS_BUILD_DIR@/girepository'
          RUN_WRAPPER_INTERP: '@BUILD_ROOT@/tools/host-mlibc/lib/ld.so'
          VALADIR: '@SYSROOT_DIR@/usr/share/vala/vapi'
          # Wrapper to add our valadir
          VAPIGEN: 'cross-vapigen'
    build:
      - args: ['ninja']
        environ:
          # Library path for our run-wrapper that allows it to load managarm libraries
          RUN_WRAPPER_LD_LIBRARY_PATH: '@BUILD_ROOT@/tools/host-mlibc/lib:@SYSROOT_DIR@/usr/lib:@SYSROOT_DIR@/usr/lib64:@THIS_BUILD_DIR@/girepository'
          # Similar to above, but using a nasty (but working) hack lets us use a Linux mlibc build to execute an
          # executable that was cross-compiled for managarm
          RUN_WRAPPER_INTERP: '@BUILD_ROOT@/tools/host-mlibc/lib/ld.so'
          # This is a custom environment variable which tells g-ir-scanner what to use instead of ldd
          # We point it at our native ldd-wrapper that's installed as part of host-gobject-introspection
          GI_LDD_WRAPPER: ldd-wrapper
          # This tells g-ir-scanner what program should be used for "cross-launching" the executables it builds
          GI_CROSS_LAUNCHER: run-wrapper
          # Path to the introspection data installed by other packages
          GI_GIR_PATH: '@SYSROOT_DIR@/usr/share/gir-1.0'
          VALADIR: '@SYSROOT_DIR@/usr/share/vala/vapi'
          # Wrapper to add our valadir
          VALAC: 'cross-valac'
          # Wrapper to add our valadir
          VAPIGEN: 'cross-vapigen'
      - args: ['ninja', 'install']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'
    scripts:
        post_install:
          - args: ['glib-compile-schemas', '/usr/share/glib-2.0/schemas']
          - args: ['gtk4-update-icon-cache', '-q', '-t', '-f', '/usr/share/icons/hicolor']
