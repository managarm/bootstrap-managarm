!<tag:y4.managarm.org:preamble>
import:
  - !std
  - !managarm
const:
  !ci-tools-required :
    - tool: ovmf
      expose: false
  !ci-tasks-required :
    - task: make-image
      order_only: true
    - task: remake-image
      order_only: true
  !ci-common-args :
    # This would be cleaner if there was an unconditional std::splice.
    !std::splice_if
    - { item: '@SOURCE_ROOT@/scripts/vm-util.py', if: true }
    - { item: 'qemu', if: true }
    - { item: '--arch', if: true }
    - { item: '@OPTION:arch@', if: true }
    - { item: '--timeout=1200', if: true }
    - { item: '--io-timeout=300', if: true }
  !ci-environ :
    QFLAGS: '-snapshot -display none'
---
tasks:
  - name: ci-all
    tasks_required:
      - ci-kernel-tests
      - ci-posix-tests
      - ci-boot-bios-limine
      - ci-boot-bios-mb2
      - ci-boot-uefi
      - ci-boot-uefi-limine
      - ci-boot-uefi-mb2
    args:
      - '/usr/bin/true'
    # This and all other CI tasks should be marked as containerless
    # such that we do not need cbuildrt and a rootfs to run them on CI.
    containerless: true
  - name: ci-boot-bios-limine
    tools_required: !ci-tools-required
    tasks_required: !ci-tasks-required
    args:
      - !ci-common-args
      - '--logfile=ci-boot-bios-limine.txt'
      - '--no-uefi'
      - '--ci-protocol=limine'
      - '--ci-script=/usr/bin/true'
    environ: !ci-environ
    workdir: '@BUILD_ROOT@'
    containerless: true
  - name: ci-boot-bios-mb2
    tools_required: !ci-tools-required
    tasks_required: !ci-tasks-required
    args:
      - !ci-common-args
      - '--logfile=ci-boot-bios-mb2.txt'
      - '--no-uefi'
      - '--ci-protocol=mb2'
      - '--ci-script=/usr/bin/true'
    environ: !ci-environ
    workdir: '@BUILD_ROOT@'
    containerless: true
  - name: ci-boot-uefi
    tools_required: !ci-tools-required
    tasks_required: !ci-tasks-required
    args:
      - !ci-common-args
      - '--logfile=ci-boot-uefi.txt'
      - '--uefi'
      - '--ci-protocol=uefi'
      - '--ci-script=/usr/bin/true'
    environ: !ci-environ
    workdir: '@BUILD_ROOT@'
    containerless: true
  - name: ci-boot-uefi-limine
    tools_required: !ci-tools-required
    tasks_required: !ci-tasks-required
    args:
      - !ci-common-args
      - '--logfile=ci-boot-uefi-limine.txt'
      - '--uefi'
      - '--ci-protocol=limine'
      - '--ci-script=/usr/bin/true'
    environ: !ci-environ
    workdir: '@BUILD_ROOT@'
    containerless: true
  - name: ci-boot-uefi-mb2
    tools_required: !ci-tools-required
    tasks_required: !ci-tasks-required
    args:
      - !ci-common-args
      - '--logfile=ci-boot-uefi-mb2.txt'
      - '--uefi'
      - '--ci-protocol=mb2'
      - '--ci-script=/usr/bin/true'
    environ: !ci-environ
    workdir: '@BUILD_ROOT@'
    containerless: true
  - name: ci-kernel-tests
    tools_required: !ci-tools-required
    tasks_required: !ci-tasks-required
    args:
      - !ci-common-args
      - '--logfile=ci-kernel-tests.txt'
      - '--uefi'
      - '--ci-script'
      - 'kernel-tests'
    environ: !ci-environ
    workdir: '@BUILD_ROOT@'
    containerless: true
  - name: ci-posix-tests
    tools_required: !ci-tools-required
    tasks_required: !ci-tasks-required
    args:
      - !ci-common-args
      - '--logfile=ci-posix-tests.txt'
      - '--uefi'
      - '--ci-script'
      - 'posix-tests'
    environ: !ci-environ
    workdir: '@BUILD_ROOT@'
    containerless: true
