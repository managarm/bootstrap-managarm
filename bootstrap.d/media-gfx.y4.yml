!<tag:y4.managarm.org:preamble>
import:
  - !managarm
---
packages:
  - name: eog
    stability_level: 'broken' # librsvg seems to be missing a patch?
    architecture: '@OPTION:arch@'
    metadata:
      summary: Eye of GNOME is an image viewer for the GNOME desktop
      description: This package provides an image viewer application for the GNOME desktop environment.
      spdx: 'GPL-2.0-or-later'
      website: 'https://gitlab.gnome.org/GNOME/eog'
      maintainer: "Dennis Bonke <dennis@managarm.org>"
      categories: ['media-gfx']
    source:
      subdir: 'ports'
      git: 'https://gitlab.gnome.org/GNOME/eog.git'
      tag: '47.0'
      version: '47.0'
    tools_required:
      - system-gcc
      - host-pkg-config
      - wayland-scanner
      - virtual: pkgconfig-for-target
        triple: "@OPTION:arch-triple@"
      - !managarm::arch_dep
        arch: [x86_64]
        item: host-mlibc
      - !managarm::arch_dep
        arch: [x86_64]
        item: host-gobject-introspection
      - host-python
      - host-glib
    pkgs_required:
      - mlibc
      - !managarm::arch_dep
        arch: [x86_64]
        item: gobject-introspection
      - gtk+-3
      - libpeas
      - libhandy
      - librsvg
      - libjpeg-turbo
      - gnome-desktop
    revision: 1
    configure:
      - args:
        - 'meson'
        - 'setup'
        - '--cross-file'
        - '@SOURCE_ROOT@/scripts/meson-@OPTION:arch-triple@-goi.cross-file'
        - '--prefix=/usr'
        - '--buildtype=release'
        - '--wrap-mode=nodownload'
        - !managarm::arch_ite
          arch: [x86_64]
          then: '-Dintrospection=true'
          else: '-Dintrospection=false'
        - '-Dinstalled_tests=false'
        - '-Dlibportal=false'
        - '-Dlibexif=false'
        - '-Dxmp=false'
        - '-Dcms=false'
        - '-Dlibjpeg=true'
        - '-Dlibrsvg=true'
        - '-Dgtk_doc=false'
        - '@THIS_SOURCE_DIR@'
        environ:
          # Same as below
          RUN_WRAPPER_LD_LIBRARY_PATH: '@BUILD_ROOT@/tools/host-mlibc/lib:@SYSROOT_DIR@/usr/lib:@SYSROOT_DIR@/usr/lib64:@THIS_BUILD_DIR@/girepository'
          RUN_WRAPPER_INTERP: '@BUILD_ROOT@/tools/host-mlibc/lib/ld.so'
    build:
      - args: ['ninja']
        environ:
          # Library path for our run-wrapper that allows it to load managarm libraries
          RUN_WRAPPER_LD_LIBRARY_PATH: '@BUILD_ROOT@/tools/host-mlibc/lib:@SYSROOT_DIR@/usr/lib:@SYSROOT_DIR@/usr/lib64:@THIS_BUILD_DIR@/girepository'
          # Similar to above, but using a nasty (but working) hack lets us use a Linux mlibc build to execute an
          # executable that was cross-compiled for managarm
          RUN_WRAPPER_INTERP: '@BUILD_ROOT@/tools/host-mlibc/lib/ld.so'
          # This is a custom environment variable which tells g-ir-scanner what to use instead of ldd
          # We point it at our native ldd-wrapper that's installed as part of host-gobject-introspection
          GI_LDD_WRAPPER: ldd-wrapper
          # This tells g-ir-scanner what program should be used for "cross-launching" the executables it builds
          GI_CROSS_LAUNCHER: run-wrapper
          # Path to the introspection data installed by other packages
          GI_GIR_PATH: '@SYSROOT_DIR@/usr/share/gir-1.0'
      - args: ['ninja', 'install']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'
          # Library path for our run-wrapper that allows it to load managarm libraries
          RUN_WRAPPER_LD_LIBRARY_PATH: '@BUILD_ROOT@/tools/host-mlibc/lib:@SYSROOT_DIR@/usr/lib:@SYSROOT_DIR@/usr/lib64:@THIS_BUILD_DIR@/girepository'
          # Similar to above, but using a nasty (but working) hack lets us use a Linux mlibc build to execute an
          # executable that was cross-compiled for managarm
          RUN_WRAPPER_INTERP: '@BUILD_ROOT@/tools/host-mlibc/lib/ld.so'
          # This is a custom environment variable which tells g-ir-scanner what to use instead of ldd
          # We point it at our native ldd-wrapper that's installed as part of host-gobject-introspection
          GI_LDD_WRAPPER: ldd-wrapper
          # This tells g-ir-scanner what program should be used for "cross-launching" the executables it builds
          GI_CROSS_LAUNCHER: run-wrapper
          # Path to the introspection data installed by other packages
          GI_GIR_PATH: '@SYSROOT_DIR@/usr/share/gir-1.0'

  - name: graphite2
    labels: [aarch64, riscv64]
    architecture: '@OPTION:arch@'
    source:
      subdir: 'ports'
      git: 'https://github.com/silnrsi/graphite.git'
      tag: '1.3.14'
      version: '1.3.14'
    tools_required:
      - system-gcc
      - host-python
      - host-cmake
    pkgs_required:
      - mlibc
      - libstdc++
    revision: 13
    configure:
      - args:
        - 'cmake'
        - '-DCMAKE_TOOLCHAIN_FILE=@SOURCE_ROOT@/scripts/CMakeToolchain-@OPTION:arch-triple@.txt'
        - '-DCMAKE_INSTALL_PREFIX=/usr'
        - '-DCMAKE_POLICY_VERSION_MINIMUM=3.5'
        - '@THIS_SOURCE_DIR@'
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'install']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'
