From f1a939bfd34f0c676a4092606c0f63f08717c36d Mon Sep 17 00:00:00 2001
From: Dennis Bonke <admin@dennisbonke.com>
Date: Sat, 9 Aug 2025 00:06:54 +0200
Subject: [PATCH 1/2] Fix dynamic linker paths and add support for backtracing
 into libgcc

---
 gcc/config/aarch64/aarch64-managarm.h | 2 +-
 gcc/config/i386/i386-managarm.h       | 6 +++---
 gcc/config/managarm.h                 | 1 +
 gcc/config/riscv/managarm.h           | 2 +-
 libgcc/config.host                    | 6 ++++--
 libgcc/unwind-dw2-fde-dip.c           | 5 +++++
 6 files changed, 15 insertions(+), 7 deletions(-)

diff --git a/gcc/config/aarch64/aarch64-managarm.h b/gcc/config/aarch64/aarch64-managarm.h
index 9143fa67301..7b84bd39588 100644
--- a/gcc/config/aarch64/aarch64-managarm.h
+++ b/gcc/config/aarch64/aarch64-managarm.h
@@ -2,7 +2,7 @@
 #undef GCC_AARCH64_MANAGARM
 #define GCC_AARCH64_MANAGARM 1
 
-#define GNU_USER_DYNAMIC_LINKER "/lib/x86_64-managarm/ld.so"
+#define GNU_USER_DYNAMIC_LINKER "/lib/aarch64-managarm-mlibc-ld.so"
 
 #define MANAGARM_TARGET_LINK_SPEC  "%{h*}		\
    %{static:-Bstatic}				\
diff --git a/gcc/config/i386/i386-managarm.h b/gcc/config/i386/i386-managarm.h
index eeba4ba008e..f86cf63911b 100644
--- a/gcc/config/i386/i386-managarm.h
+++ b/gcc/config/i386/i386-managarm.h
@@ -6,6 +6,6 @@
 #define GNU_USER_LINK_EMULATION64 "elf_x86_64"
 #define GNU_USER_LINK_EMULATIONX32 "elf32_x86_64"
 
-#define GNU_USER_DYNAMIC_LINKER32 "/lib/i386-managarm/ld.so"
-#define GNU_USER_DYNAMIC_LINKER64 "/lib/x86_64-managarm/ld.so"
-#define GNU_USER_DYNAMIC_LINKERX32 "/lib/x86_64-managarm-x32/ld.so"
+#define GNU_USER_DYNAMIC_LINKER32 "/lib/i386-managarm-mlibc-ld.so"
+#define GNU_USER_DYNAMIC_LINKER64 "/lib/x86_64-managarm-mlibc-ld.so"
+#define GNU_USER_DYNAMIC_LINKERX32 "/lib/x86_64-managarm-x32-mlibc-ld.so"
diff --git a/gcc/config/managarm.h b/gcc/config/managarm.h
index 517e68c38c8..a5fdf77fe05 100644
--- a/gcc/config/managarm.h
+++ b/gcc/config/managarm.h
@@ -6,6 +6,7 @@
 #define TARGET_OS_CPP_BUILTINS()		\
   do {						\
     builtin_define ("__managarm__");		\
+    builtin_define ("__mlibc__");		\
     builtin_define ("__unix__");		\
     builtin_assert ("system=managarm");		\
     builtin_assert ("system=unix");		\
diff --git a/gcc/config/riscv/managarm.h b/gcc/config/riscv/managarm.h
index 2c5db55214d..64cbdd4aa01 100644
--- a/gcc/config/riscv/managarm.h
+++ b/gcc/config/riscv/managarm.h
@@ -41,7 +41,7 @@ along with GCC; see the file COPYING3.  If not see
   "%{mabi=ilp32f:_ilp32f}" \
   "%{mabi=ilp32:_ilp32}"
 
-#define GNU_USER_DYNAMIC_LINKER "/lib/riscv-managarm/ld" XLEN_SPEC "-" ABI_SPEC ".so"
+#define GNU_USER_DYNAMIC_LINKER "/lib/riscv64-managarm-mlibc-ld.so"
 
 #define LINK_SPEC "\
 -melf" XLEN_SPEC DEFAULT_ENDIAN_SPEC "riscv" LD_EMUL_SUFFIX " \
diff --git a/libgcc/config.host b/libgcc/config.host
index 6317343ea95..4289f7a4f2b 100644
--- a/libgcc/config.host
+++ b/libgcc/config.host
@@ -321,7 +321,7 @@ case ${host} in
       ;;
   esac
   tmake_file="$tmake_file t-crtstuff-pic"
-  tmake_file="$tmake_file t-slibgcc t-slibgcc-gld t-slibgcc-elf-ver t-libgcc-pic"
+  tmake_file="$tmake_file t-slibgcc t-slibgcc-gld t-slibgcc-elf-ver t-libgcc-pic t-eh-dw2-dip"
   ;;
 *-*-lynxos*)
   tmake_file="$tmake_file t-lynx $cpu_type/t-crtstuff t-crtstuff-pic t-libgcc-pic"
@@ -808,7 +808,8 @@ i[34567]86-*-linux*)
 x86_64-*-managarm*)
 	extra_parts="$extra_parts crtprec32.o crtprec64.o crtprec80.o crtfastmath.o"
 	tmake_file="$tmake_file i386/t-crtpc t-crtfm i386/t-crtstuff t-dfprules"
-	tmake_file="$tmake_file i386/t-linux"
+	tm_file="${tm_file} i386/elf-lib.h"
+	md_unwind_header=i386/linux-unwind.h
 	;;
 i[34567]86-*-kfreebsd*-gnu | i[34567]86-*-kopensolaris*-gnu)
 	extra_parts="$extra_parts crtprec32.o crtprec64.o crtprec80.o crtfastmath.o"
@@ -1619,6 +1620,7 @@ esac
 
 case ${host} in
 i[34567]86-*-linux* | x86_64-*-linux* | \
+  i[34567]86-*-managarm* | x86_64-*-managarm* | \
   i[34567]86-*-kfreebsd*-gnu | x86_64-*-kfreebsd*-gnu | \
   i[34567]86-*-gnu* | x86_64-*-gnu*)
 	tmake_file="${tmake_file} t-tls i386/t-linux i386/t-msabi t-slibgcc-libgcc"
diff --git a/libgcc/unwind-dw2-fde-dip.c b/libgcc/unwind-dw2-fde-dip.c
index 57d0c8812b1..38913e490a2 100644
--- a/libgcc/unwind-dw2-fde-dip.c
+++ b/libgcc/unwind-dw2-fde-dip.c
@@ -83,6 +83,11 @@
 # define USE_PT_GNU_EH_FRAME
 #endif
 
+#if !defined(inhibit_libc) && defined(HAVE_LD_EH_FRAME_HDR) \
+    && defined(__managarm__)
+# define USE_PT_GNU_EH_FRAME
+#endif
+
 #if defined(USE_PT_GNU_EH_FRAME)
 
 #include <link.h>
-- 
2.52.0

