From a5cae70e2a970000e15aa0fc3815ac6ffeb76b92 Mon Sep 17 00:00:00 2001
From: Dennis Bonke <admin@dennisbonke.com>
Date: Sun, 30 Jan 2022 21:53:07 +0100
Subject: [PATCH 2/2] WIP Xorg patch

Signed-off-by: Dennis Bonke <admin@dennisbonke.com>
---
 hw/xfree86/common/xf86.h                     | 14 +++++++-------
 hw/xfree86/common/xf86Config.c               |  1 +
 hw/xfree86/common/xf86Configure.c            |  1 +
 hw/xfree86/common/xf86Events.c               |  1 +
 hw/xfree86/drivers/modesetting/dumb_bo.c     |  2 ++
 hw/xfree86/fbdevhw/fbdevhw.c                 |  3 ++-
 hw/xfree86/fbdevhw/meson.build               |  2 ++
 hw/xfree86/os-support/bus/Pci.h              |  2 +-
 hw/xfree86/os-support/meson.build            | 11 +++++++++++
 hw/xfree86/os-support/shared/platform_noop.c | 15 +++++++++++++++
 hw/xfree86/os-support/shared/posix_tty.c     |  2 ++
 hw/xfree86/os-support/shared/sigio.c         |  2 ++
 meson.build                                  |  2 +-
 13 files changed, 48 insertions(+), 10 deletions(-)

diff --git a/hw/xfree86/common/xf86.h b/hw/xfree86/common/xf86.h
index 5743f0c..65801c5 100644
--- a/hw/xfree86/common/xf86.h
+++ b/hw/xfree86/common/xf86.h
@@ -126,13 +126,13 @@ extern _X_EXPORT ScrnInfoPtr xf86ConfigPciEntity(ScrnInfoPtr pScrn,
                                                  EntityProc leave,
                                                  void *private);
 #else
-#define xf86VGAarbiterInit() do {} while (0)
-#define xf86VGAarbiterFini() do {} while (0)
-#define xf86VGAarbiterLock(x) do {} while (0)
-#define xf86VGAarbiterUnlock(x) do {} while (0)
-#define xf86VGAarbiterScrnInit(x) do {} while (0)
-#define xf86VGAarbiterDeviceDecodes() do {} while (0)
-#define xf86VGAarbiterWrapFunctions() do {} while (0)
+//#define xf86VGAarbiterInit() do {} while (0)
+//#define xf86VGAarbiterFini() do {} while (0)
+//#define xf86VGAarbiterLock(x) do {} while (0)
+//#define xf86VGAarbiterUnlock(x) do {} while (0)
+//#define xf86VGAarbiterScrnInit(x) do {} while (0)
+//#define xf86VGAarbiterDeviceDecodes() do {} while (0)
+//#define xf86VGAarbiterWrapFunctions() do {} while (0)
 #endif
 
 /* xf86Bus.c */
diff --git a/hw/xfree86/common/xf86Config.c b/hw/xfree86/common/xf86Config.c
index 09d27ec..416b557 100644
--- a/hw/xfree86/common/xf86Config.c
+++ b/hw/xfree86/common/xf86Config.c
@@ -45,6 +45,7 @@
 #ifdef HAVE_XORG_CONFIG_H
 #include <xorg-config.h>
 #endif
+#include <sys/stat.h>
 
 #include <sys/types.h>
 #include <grp.h>
diff --git a/hw/xfree86/common/xf86Configure.c b/hw/xfree86/common/xf86Configure.c
index 44e7591..cf45ed1 100644
--- a/hw/xfree86/common/xf86Configure.c
+++ b/hw/xfree86/common/xf86Configure.c
@@ -26,6 +26,7 @@
 #ifdef HAVE_XORG_CONFIG_H
 #include <xorg-config.h>
 #endif
+#include <errno.h>
 
 #include "xf86.h"
 #include "xf86Config.h"
diff --git a/hw/xfree86/common/xf86Events.c b/hw/xfree86/common/xf86Events.c
index 8a800bd..ac8ed3c 100644
--- a/hw/xfree86/common/xf86Events.c
+++ b/hw/xfree86/common/xf86Events.c
@@ -52,6 +52,7 @@
 #ifdef HAVE_XORG_CONFIG_H
 #include <xorg-config.h>
 #endif
+#include <errno.h>
 
 #include <X11/X.h>
 #include <X11/Xproto.h>
diff --git a/hw/xfree86/drivers/modesetting/dumb_bo.c b/hw/xfree86/drivers/modesetting/dumb_bo.c
index cf13f0a..8ce78ae 100644
--- a/hw/xfree86/drivers/modesetting/dumb_bo.c
+++ b/hw/xfree86/drivers/modesetting/dumb_bo.c
@@ -38,6 +38,7 @@
 #include <sys/mman.h>
 #include <unistd.h>
 #include <xf86drm.h>
+#include <stdio.h>
 
 struct dumb_bo *
 dumb_bo_create(int fd,
@@ -46,6 +47,7 @@ dumb_bo_create(int fd,
     struct drm_mode_create_dumb arg;
     struct dumb_bo *bo;
     int ret;
+    fprintf(stderr, "XORG-SERVER: height %u width %u bpp %u\n", height, width, bpp);
 
     bo = calloc(1, sizeof(*bo));
     if (!bo)
diff --git a/hw/xfree86/fbdevhw/fbdevhw.c b/hw/xfree86/fbdevhw/fbdevhw.c
index 9508951..3e064e1 100644
--- a/hw/xfree86/fbdevhw/fbdevhw.c
+++ b/hw/xfree86/fbdevhw/fbdevhw.c
@@ -15,7 +15,8 @@
 #include "xf86cmap.h"
 
 #include "fbdevhw.h"
-#include "fbpriv.h"
+//#include "fbpriv.h"
+#include <linux/fb.h>
 #include "globals.h"
 #include <X11/extensions/dpmsconst.h>
 
diff --git a/hw/xfree86/fbdevhw/meson.build b/hw/xfree86/fbdevhw/meson.build
index f3146f3..1955e7d 100644
--- a/hw/xfree86/fbdevhw/meson.build
+++ b/hw/xfree86/fbdevhw/meson.build
@@ -1,5 +1,7 @@
 if host_machine.system() == 'linux'
     srcs_fbdevhw = 'fbdevhw.c'
+elif host_machine.system() == 'managarm'
+    srcs_fbdevhw = 'fbdevhw.c'
 else
     srcs_fbdevhw = 'fbdevhwstub.c'
 endif
diff --git a/hw/xfree86/os-support/bus/Pci.h b/hw/xfree86/os-support/bus/Pci.h
index 1921e02..dc56273 100644
--- a/hw/xfree86/os-support/bus/Pci.h
+++ b/hw/xfree86/os-support/bus/Pci.h
@@ -139,7 +139,7 @@
 #define osPciInit(x) do {} while (0)
 #elif defined(__FreeBSD__) || defined(__FreeBSD_kernel__) || \
 	defined(__OpenBSD__) || defined(__NetBSD__) || \
-	defined(__DragonFly__) || defined(__sun) || defined(__GNU__)
+	defined(__DragonFly__) || defined(__sun) || defined(__GNU__) || defined(__managarm__)
 extern void osPciInit(void);
 #else
 #error No PCI support available for this architecture/OS combination
diff --git a/hw/xfree86/os-support/meson.build b/hw/xfree86/os-support/meson.build
index b6e5c97..227b3d3 100644
--- a/hw/xfree86/os-support/meson.build
+++ b/hw/xfree86/os-support/meson.build
@@ -113,6 +113,16 @@ elif host_machine.system().endswith('bsd')
     else
         srcs_xorg_os_support += 'shared/agp_noop.c'
     endif
+#elif host_machine.system() == 'managarm'
+#    srcs_xorg_os_support += [
+#	'linux/lnx_platform.c',
+#	'linux/lnx_init.c',
+#	'linux/lnx_video.c',
+#	'stub/stub_init.c',
+#        'stub/stub_video.c',
+#	'stub/stub_bell.c',
+#    ]
+    #error('uwu')
 else
     # stub ossupport
     srcs_xorg_os_support += [
@@ -121,6 +131,7 @@ else
         'shared/ioperm_noop.c',
         'shared/kmod_noop.c',
         'shared/pm_noop.c',
+	'shared/platform_noop.c',
         'shared/vidmem.c',
         'shared/posix_tty.c',
         'shared/sigio.c',
diff --git a/hw/xfree86/os-support/shared/platform_noop.c b/hw/xfree86/os-support/shared/platform_noop.c
index 199ae5e..a9568d6 100644
--- a/hw/xfree86/os-support/shared/platform_noop.c
+++ b/hw/xfree86/os-support/shared/platform_noop.c
@@ -19,5 +19,20 @@ xf86PlatformDeviceCheckBusID(struct xf86_platform_device *device, const char *bu
 void xf86PlatformDeviceProbe(struct OdevAttributes *attribs)
 {
 
+}
+
+void xf86PlatformReprobeDevice(int index, struct OdevAttributes *attribs)
+{
+
+}
+
+void NewGPUDeviceRequest(struct OdevAttributes *attribs)
+{
+
+}
+
+void DeleteGPUDeviceRequest(struct OdevAttributes *attribs)
+{
+
 }
 #endif
diff --git a/hw/xfree86/os-support/shared/posix_tty.c b/hw/xfree86/os-support/shared/posix_tty.c
index 0cb9788..863f98f 100644
--- a/hw/xfree86/os-support/shared/posix_tty.c
+++ b/hw/xfree86/os-support/shared/posix_tty.c
@@ -55,6 +55,8 @@
 #ifdef HAVE_XORG_CONFIG_H
 #include <xorg-config.h>
 #endif
+#include <errno.h>
+#include <termios.h>
 
 #include <X11/X.h>
 #include <xserver_poll.h>
diff --git a/hw/xfree86/os-support/shared/sigio.c b/hw/xfree86/os-support/shared/sigio.c
index 247bec7..17e0e78 100644
--- a/hw/xfree86/os-support/shared/sigio.c
+++ b/hw/xfree86/os-support/shared/sigio.c
@@ -55,6 +55,8 @@
 #ifdef HAVE_XORG_CONFIG_H
 #include <xorg-config.h>
 #endif
+#include <errno.h>
+#include <sys/stat.h>
 
 #include <X11/X.h>
 #include <xserver_poll.h>
diff --git a/meson.build b/meson.build
index c74135a..6b29dc5 100644
--- a/meson.build
+++ b/meson.build
@@ -31,7 +31,7 @@ if cc.get_id() == 'gcc' or cc.get_id() == 'clang'
         '-Wmissing-noreturn',
         '-Wmissing-format-attribute',
         '-Wredundant-decls',
-        '-Werror=implicit',
+#        '-Werror=implicit',
         '-Werror=nonnull',
         '-Werror=init-self',
         '-Werror=main',
-- 
2.34.1

