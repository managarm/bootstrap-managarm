From c4c04af034ecbca4d3d46cae0e65de2f970b0962 Mon Sep 17 00:00:00 2001
From: no92 <no92.mail@gmail.com>
Date: Fri, 9 Jan 2026 11:39:38 +0100
Subject: [PATCH 4/4] Add mlibc bindings

---
 src/new/common/linux_like/mod.rs     |  3 +-
 src/new/common/linux_like/pthread.rs |  8 +--
 src/new/common/mod.rs                |  1 +
 src/new/common/posix/mod.rs          |  1 +
 src/new/common/posix/pthread.rs      | 77 ++++++++++++++++------------
 src/new/mlibc/mod.rs                 |  2 +
 src/new/mlibc/pthread.rs             | 56 ++++++++++++++++++++
 src/new/mlibc/unistd.rs              |  7 +++
 src/new/mod.rs                       |  6 ++-
 9 files changed, 123 insertions(+), 38 deletions(-)
 create mode 100644 src/new/mlibc/mod.rs
 create mode 100644 src/new/mlibc/pthread.rs
 create mode 100644 src/new/mlibc/unistd.rs

diff --git a/src/new/common/linux_like/mod.rs b/src/new/common/linux_like/mod.rs
index 9c41fe256..76aa6256d 100644
--- a/src/new/common/linux_like/mod.rs
+++ b/src/new/common/linux_like/mod.rs
@@ -4,6 +4,7 @@
     target_os = "android",
     target_os = "emscripten",
     target_os = "l4re",
-    target_os = "linux"
+    target_os = "linux",
+    target_os = "managarm"
 ))]
 pub(crate) mod pthread;
diff --git a/src/new/common/linux_like/pthread.rs b/src/new/common/linux_like/pthread.rs
index b54d385f9..dd2eb3665 100644
--- a/src/new/common/linux_like/pthread.rs
+++ b/src/new/common/linux_like/pthread.rs
@@ -1,7 +1,7 @@
 use crate::prelude::*;
 
 extern "C" {
-    #[cfg(any(target_os = "linux", target_os = "l4re"))]
+    #[cfg(any(target_os = "linux", target_os = "l4re", target_os = "managarm"))]
     pub fn pthread_getaffinity_np(
         thread: crate::pthread_t,
         cpusetsize: size_t,
@@ -10,16 +10,16 @@ extern "C" {
 
     pub fn pthread_getattr_np(native: crate::pthread_t, attr: *mut crate::pthread_attr_t) -> c_int;
 
-    #[cfg(target_os = "linux")]
+    #[cfg(any(target_os = "linux", target_os = "managarm"))]
     pub fn pthread_getname_np(thread: crate::pthread_t, name: *mut c_char, len: size_t) -> c_int;
 
-    #[cfg(any(target_os = "linux", target_os = "l4re"))]
+    #[cfg(any(target_os = "linux", target_os = "l4re", target_os = "managarm"))]
     pub fn pthread_setaffinity_np(
         thread: crate::pthread_t,
         cpusetsize: size_t,
         cpuset: *const crate::cpu_set_t,
     ) -> c_int;
 
-    #[cfg(any(target_os = "android", target_os = "linux"))]
+    #[cfg(any(target_os = "android", target_os = "linux", target_os = "managarm"))]
     pub fn pthread_setname_np(thread: crate::pthread_t, name: *const c_char) -> c_int;
 }
diff --git a/src/new/common/mod.rs b/src/new/common/mod.rs
index acb18917c..027b3d94a 100644
--- a/src/new/common/mod.rs
+++ b/src/new/common/mod.rs
@@ -23,6 +23,7 @@ pub(crate) mod bsd;
     target_os = "emscripten",
     target_os = "l4re",
     target_os = "linux",
+    target_os = "managarm",
 ))]
 pub(crate) mod linux_like;
 
diff --git a/src/new/common/posix/mod.rs b/src/new/common/posix/mod.rs
index 44ae64a98..10b4c0856 100644
--- a/src/new/common/posix/mod.rs
+++ b/src/new/common/posix/mod.rs
@@ -8,6 +8,7 @@
     target_os = "emscripten",
     target_os = "l4re",
     target_os = "linux",
+    target_os = "managarm",
     target_os = "qurt",
     target_vendor = "apple",
 ))]
diff --git a/src/new/common/posix/pthread.rs b/src/new/common/posix/pthread.rs
index 146cd6042..83e4d42d3 100644
--- a/src/new/common/posix/pthread.rs
+++ b/src/new/common/posix/pthread.rs
@@ -5,14 +5,14 @@
 use crate::prelude::*;
 
 extern "C" {
-    #[cfg(any(target_os = "android", target_os = "linux"))]
+    #[cfg(any(target_os = "android", target_os = "linux", target_os = "managarm"))]
     pub fn pthread_atfork(
         prepare: Option<unsafe extern "C" fn()>,
         parent: Option<unsafe extern "C" fn()>,
         child: Option<unsafe extern "C" fn()>,
     ) -> c_int;
 
-    #[cfg(any(target_os = "android", target_os = "l4re", target_os = "linux"))]
+    #[cfg(any(target_os = "android", target_os = "l4re", target_os = "linux", target_os = "managarm"))]
     pub fn pthread_attr_getguardsize(
         attr: *const crate::pthread_attr_t,
         guardsize: *mut size_t,
@@ -22,6 +22,7 @@ extern "C" {
         target_os = "android",
         target_os = "l4re",
         target_os = "linux",
+        target_os = "managarm",
         target_vendor = "apple",
     ))]
     pub fn pthread_attr_getinheritsched(
@@ -29,13 +30,13 @@ extern "C" {
         inheritsched: *mut c_int,
     ) -> c_int;
 
-    #[cfg(any(target_os = "l4re", target_os = "linux", target_vendor = "apple"))]
+    #[cfg(any(target_os = "l4re", target_os = "linux", target_os = "managarm", target_vendor = "apple"))]
     pub fn pthread_attr_getschedparam(
         attr: *const crate::pthread_attr_t,
         param: *mut crate::sched_param,
     ) -> c_int;
 
-    #[cfg(any(target_os = "l4re", target_os = "linux", target_vendor = "apple"))]
+    #[cfg(any(target_os = "l4re", target_os = "linux", target_os = "managarm", target_vendor = "apple"))]
     pub fn pthread_attr_getschedpolicy(
         attr: *const crate::pthread_attr_t,
         policy: *mut c_int,
@@ -45,7 +46,8 @@ extern "C" {
         target_os = "android",
         target_os = "emscripten",
         target_os = "linux",
-        target_os = "l4re"
+        target_os = "l4re",
+        target_os = "managarm",
     ))]
     pub fn pthread_attr_getstack(
         attr: *const crate::pthread_attr_t,
@@ -53,13 +55,14 @@ extern "C" {
         stacksize: *mut size_t,
     ) -> c_int;
 
-    #[cfg(any(target_os = "android", target_os = "l4re", target_os = "linux"))]
+    #[cfg(any(target_os = "android", target_os = "l4re", target_os = "linux", target_os = "managarm"))]
     pub fn pthread_attr_setguardsize(attr: *mut crate::pthread_attr_t, guardsize: size_t) -> c_int;
 
     #[cfg(any(
         target_os = "android",
         target_os = "l4re",
         target_os = "linux",
+        target_os = "managarm",
         target_vendor = "apple"
     ))]
     pub fn pthread_attr_setinheritsched(
@@ -67,19 +70,20 @@ extern "C" {
         inheritsched: c_int,
     ) -> c_int;
 
-    #[cfg(any(target_os = "l4re", target_os = "linux", target_vendor = "apple"))]
+    #[cfg(any(target_os = "l4re", target_os = "linux", target_os = "managarm", target_vendor = "apple"))]
     pub fn pthread_attr_setschedparam(
         attr: *mut crate::pthread_attr_t,
         param: *const crate::sched_param,
     ) -> c_int;
 
-    #[cfg(any(target_os = "l4re", target_os = "linux", target_vendor = "apple"))]
+    #[cfg(any(target_os = "l4re", target_os = "linux", target_os = "managarm", target_vendor = "apple"))]
     pub fn pthread_attr_setschedpolicy(attr: *mut crate::pthread_attr_t, policy: c_int) -> c_int;
 
     #[cfg(any(
         target_os = "android",
         target_os = "emscripten",
         target_os = "linux",
+        target_os = "managarm",
         target_os = "l4re"
     ))]
     pub fn pthread_attr_setstack(
@@ -88,41 +92,41 @@ extern "C" {
         stacksize: size_t,
     ) -> c_int;
 
-    #[cfg(any(target_os = "android", target_os = "l4re", target_os = "linux"))]
+    #[cfg(any(target_os = "android", target_os = "l4re", target_os = "linux", target_os = "managarm"))]
     pub fn pthread_barrier_destroy(barrier: *mut crate::pthread_barrier_t) -> c_int;
 
-    #[cfg(any(target_os = "android", target_os = "l4re", target_os = "linux"))]
+    #[cfg(any(target_os = "android", target_os = "l4re", target_os = "linux", target_os = "managarm"))]
     pub fn pthread_barrier_init(
         barrier: *mut crate::pthread_barrier_t,
         attr: *const crate::pthread_barrierattr_t,
         count: c_uint,
     ) -> c_int;
 
-    #[cfg(any(target_os = "android", target_os = "l4re", target_os = "linux"))]
+    #[cfg(any(target_os = "android", target_os = "l4re", target_os = "linux", target_os = "managarm"))]
     pub fn pthread_barrier_wait(barrier: *mut crate::pthread_barrier_t) -> c_int;
 
-    #[cfg(any(target_os = "android", target_os = "l4re", target_os = "linux"))]
+    #[cfg(any(target_os = "android", target_os = "l4re", target_os = "linux", target_os = "managarm"))]
     pub fn pthread_barrierattr_destroy(attr: *mut crate::pthread_barrierattr_t) -> c_int;
 
-    #[cfg(any(target_os = "android", target_os = "linux"))]
+    #[cfg(any(target_os = "android", target_os = "linux", target_os = "managarm"))]
     pub fn pthread_barrierattr_getpshared(
         attr: *const crate::pthread_barrierattr_t,
         shared: *mut c_int,
     ) -> c_int;
 
-    #[cfg(any(target_os = "android", target_os = "l4re", target_os = "linux"))]
+    #[cfg(any(target_os = "android", target_os = "l4re", target_os = "linux", target_os = "managarm"))]
     pub fn pthread_barrierattr_init(attr: *mut crate::pthread_barrierattr_t) -> c_int;
 
-    #[cfg(any(target_os = "android", target_os = "l4re", target_os = "linux"))]
+    #[cfg(any(target_os = "android", target_os = "l4re", target_os = "linux", target_os = "managarm"))]
     pub fn pthread_barrierattr_setpshared(
         attr: *mut crate::pthread_barrierattr_t,
         shared: c_int,
     ) -> c_int;
 
-    #[cfg(any(target_os = "l4re", all(target_os = "linux", not(target_env = "ohos"))))]
+    #[cfg(any(target_os = "l4re", all(target_os = "linux", not(target_env = "ohos")), target_os = "managarm"))]
     pub fn pthread_cancel(thread: crate::pthread_t) -> c_int;
 
-    #[cfg(any(target_os = "android", target_os = "emscripten", target_os = "linux",))]
+    #[cfg(any(target_os = "android", target_os = "emscripten", target_os = "linux", target_os = "managarm"))]
     pub fn pthread_condattr_getclock(
         attr: *const crate::pthread_condattr_t,
         clock_id: *mut crate::clockid_t,
@@ -132,6 +136,7 @@ extern "C" {
         target_os = "android",
         target_os = "l4re",
         target_os = "linux",
+        target_os = "managarm",
         target_vendor = "apple",
     ))]
     pub fn pthread_condattr_getpshared(
@@ -139,7 +144,7 @@ extern "C" {
         pshared: *mut c_int,
     ) -> c_int;
 
-    #[cfg(any(target_os = "android", target_os = "emscripten", target_os = "linux",))]
+    #[cfg(any(target_os = "android", target_os = "emscripten", target_os = "linux", target_os = "managarm"))]
     pub fn pthread_condattr_setclock(
         attr: *mut crate::pthread_condattr_t,
         clock_id: crate::clockid_t,
@@ -149,6 +154,7 @@ extern "C" {
         target_os = "android",
         target_os = "emscripten",
         target_os = "linux",
+        target_os = "managarm",
         target_os = "l4re",
         target_vendor = "apple",
     ))]
@@ -162,6 +168,7 @@ extern "C" {
         target_os = "emscripten",
         target_os = "l4re",
         target_os = "linux",
+        target_os = "managarm",
     ))]
     pub fn pthread_create(
         native: *mut crate::pthread_t,
@@ -177,6 +184,7 @@ extern "C" {
         target_os = "android",
         target_os = "l4re",
         target_os = "linux",
+        target_os = "managarm",
         target_vendor = "apple",
     ))]
     pub fn pthread_getschedparam(
@@ -187,13 +195,13 @@ extern "C" {
 
     // FIXME(reorg): In recent POSIX versions, this is a signal.h function and not required
     // in pthread.
-    #[cfg(any(target_os = "android", target_os = "l4re", target_os = "linux"))]
+    #[cfg(any(target_os = "android", target_os = "l4re", target_os = "linux", target_os = "managarm"))]
     pub fn pthread_kill(thread: crate::pthread_t, sig: c_int) -> c_int;
 
-    #[cfg(all(target_os = "linux", not(target_env = "ohos")))]
+    #[cfg(any(all(target_os = "linux", not(target_env = "ohos")), target_os = "managarm"))]
     pub fn pthread_mutex_consistent(mutex: *mut crate::pthread_mutex_t) -> c_int;
 
-    #[cfg(any(target_os = "android", target_os = "l4re", target_os = "linux"))]
+    #[cfg(any(target_os = "android", target_os = "l4re", target_os = "linux", target_os = "managarm"))]
     #[cfg_attr(gnu_time_bits64, link_name = "__pthread_mutex_timedlock64")]
     #[cfg_attr(musl32_time64, link_name = "__pthread_mutex_timedlock_time64")]
     pub fn pthread_mutex_timedlock(
@@ -201,7 +209,7 @@ extern "C" {
         abstime: *const crate::timespec,
     ) -> c_int;
 
-    #[cfg(target_os = "linux")]
+    #[cfg(any(target_os = "linux", target_os = "managarm"))]
     pub fn pthread_mutexattr_getprotocol(
         attr: *const crate::pthread_mutexattr_t,
         protocol: *mut c_int,
@@ -211,6 +219,7 @@ extern "C" {
         target_os = "android",
         target_os = "l4re",
         target_os = "linux",
+        target_os = "managarm",
         target_vendor = "apple",
     ))]
     pub fn pthread_mutexattr_getpshared(
@@ -218,13 +227,13 @@ extern "C" {
         pshared: *mut c_int,
     ) -> c_int;
 
-    #[cfg(all(target_os = "linux", not(target_env = "ohos")))]
+    #[cfg(any(all(target_os = "linux", not(target_env = "ohos")), target_os = "managarm"))]
     pub fn pthread_mutexattr_getrobust(
         attr: *const crate::pthread_mutexattr_t,
         robustness: *mut c_int,
     ) -> c_int;
 
-    #[cfg(target_os = "linux")]
+    #[cfg(any(target_os = "linux", target_os = "managarm"))]
     pub fn pthread_mutexattr_setprotocol(
         attr: *mut crate::pthread_mutexattr_t,
         protocol: c_int,
@@ -235,6 +244,7 @@ extern "C" {
         target_os = "emscripten",
         target_os = "linux",
         target_os = "l4re",
+        target_os = "managarm",
         target_vendor = "apple",
     ))]
     pub fn pthread_mutexattr_setpshared(
@@ -242,7 +252,7 @@ extern "C" {
         pshared: c_int,
     ) -> c_int;
 
-    #[cfg(all(target_os = "linux", not(target_env = "ohos")))]
+    #[cfg(any(all(target_os = "linux", not(target_env = "ohos")), target_os = "managarm"))]
     pub fn pthread_mutexattr_setrobust(
         attr: *mut crate::pthread_mutexattr_t,
         robustness: c_int,
@@ -253,6 +263,7 @@ extern "C" {
         target_os = "emscripten",
         target_os = "linux",
         target_os = "l4re",
+        target_os = "managarm",
         target_vendor = "apple",
     ))]
     pub fn pthread_rwlockattr_getpshared(
@@ -265,6 +276,7 @@ extern "C" {
         target_os = "emscripten",
         target_os = "linux",
         target_os = "l4re",
+        target_os = "managarm",
         target_vendor = "apple",
     ))]
     pub fn pthread_rwlockattr_setpshared(
@@ -273,7 +285,7 @@ extern "C" {
     ) -> c_int;
 
     // FIXME(1.0): These shoul be combined to the version that takes an optional unsafe function.
-    #[cfg(any(target_os = "l4re", target_os = "linux"))]
+    #[cfg(any(target_os = "l4re", target_os = "linux", target_os = "managarm"))]
     pub fn pthread_once(control: *mut crate::pthread_once_t, routine: extern "C" fn()) -> c_int;
     #[cfg(target_vendor = "apple")]
     pub fn pthread_once(
@@ -285,6 +297,7 @@ extern "C" {
         target_os = "android",
         target_os = "l4re",
         target_os = "linux",
+        target_os = "managarm",
         target_vendor = "apple",
     ))]
     pub fn pthread_setschedparam(
@@ -298,25 +311,25 @@ extern "C" {
 
     // FIXME(reorg): In recent POSIX versions, this is a signal.h function and not required
     // in pthread.
-    #[cfg(any(target_os = "android", target_os = "l4re", target_os = "linux"))]
+    #[cfg(any(target_os = "android", target_os = "l4re", target_os = "linux", target_os = "managarm"))]
     pub fn pthread_sigmask(
         how: c_int,
         set: *const crate::sigset_t,
         oldset: *mut crate::sigset_t,
     ) -> c_int;
 
-    #[cfg(any(target_os = "android", target_os = "l4re", target_os = "linux"))]
+    #[cfg(any(target_os = "android", target_os = "l4re", target_os = "linux", target_os = "managarm"))]
     pub fn pthread_spin_destroy(lock: *mut crate::pthread_spinlock_t) -> c_int;
 
-    #[cfg(any(target_os = "android", target_os = "l4re", target_os = "linux"))]
+    #[cfg(any(target_os = "android", target_os = "l4re", target_os = "linux", target_os = "managarm"))]
     pub fn pthread_spin_init(lock: *mut crate::pthread_spinlock_t, pshared: c_int) -> c_int;
 
-    #[cfg(any(target_os = "android", target_os = "l4re", target_os = "linux"))]
+    #[cfg(any(target_os = "android", target_os = "l4re", target_os = "linux", target_os = "managarm"))]
     pub fn pthread_spin_lock(lock: *mut crate::pthread_spinlock_t) -> c_int;
 
-    #[cfg(any(target_os = "android", target_os = "l4re", target_os = "linux"))]
+    #[cfg(any(target_os = "android", target_os = "l4re", target_os = "linux", target_os = "managarm"))]
     pub fn pthread_spin_trylock(lock: *mut crate::pthread_spinlock_t) -> c_int;
 
-    #[cfg(any(target_os = "android", target_os = "l4re", target_os = "linux"))]
+    #[cfg(any(target_os = "android", target_os = "l4re", target_os = "linux", target_os = "managarm"))]
     pub fn pthread_spin_unlock(lock: *mut crate::pthread_spinlock_t) -> c_int;
 }
diff --git a/src/new/mlibc/mod.rs b/src/new/mlibc/mod.rs
new file mode 100644
index 000000000..99664b12f
--- /dev/null
+++ b/src/new/mlibc/mod.rs
@@ -0,0 +1,2 @@
+pub(crate) mod pthread;
+pub(crate) mod unistd;
diff --git a/src/new/mlibc/pthread.rs b/src/new/mlibc/pthread.rs
new file mode 100644
index 000000000..df519fabd
--- /dev/null
+++ b/src/new/mlibc/pthread.rs
@@ -0,0 +1,56 @@
+//! Header: `pthread.h`
+
+pub use crate::new::common::linux_like::pthread::{
+    pthread_getaffinity_np,
+    pthread_getattr_np,
+    pthread_getname_np,
+    pthread_setaffinity_np,
+    pthread_setname_np,
+};
+
+pub use crate::new::common::posix::pthread::{
+    pthread_atfork,
+    pthread_attr_getguardsize,
+    pthread_attr_getinheritsched,
+    pthread_attr_getschedparam,
+    pthread_attr_getschedpolicy,
+    pthread_attr_getstack,
+    pthread_attr_setguardsize,
+    pthread_attr_setinheritsched,
+    pthread_attr_setschedparam,
+    pthread_attr_setschedpolicy,
+    pthread_attr_setstack,
+    pthread_barrier_destroy,
+    pthread_barrier_init,
+    pthread_barrier_wait,
+    pthread_barrierattr_destroy,
+    pthread_barrierattr_getpshared,
+    pthread_barrierattr_init,
+    pthread_barrierattr_setpshared,
+    pthread_condattr_getclock,
+    pthread_condattr_getpshared,
+    pthread_condattr_setclock,
+    pthread_condattr_setpshared,
+    pthread_create,
+    pthread_getschedparam,
+    pthread_kill,
+    pthread_mutex_timedlock,
+    pthread_mutexattr_getprotocol,
+    pthread_mutexattr_getpshared,
+    pthread_mutexattr_setprotocol,
+    pthread_mutexattr_setpshared,
+    pthread_once,
+    pthread_rwlockattr_getpshared,
+    pthread_rwlockattr_setpshared,
+    pthread_setschedparam,
+    pthread_sigmask,
+    pthread_spin_destroy,
+    pthread_spin_init,
+    pthread_spin_lock,
+    pthread_spin_trylock,
+    pthread_spin_unlock,
+    pthread_cancel,
+    pthread_mutex_consistent,
+    pthread_mutexattr_getrobust,
+    pthread_mutexattr_setrobust,
+};
diff --git a/src/new/mlibc/unistd.rs b/src/new/mlibc/unistd.rs
new file mode 100644
index 000000000..8d55ee582
--- /dev/null
+++ b/src/new/mlibc/unistd.rs
@@ -0,0 +1,7 @@
+//! Header: `unistd.h`
+
+pub use crate::new::common::posix::unistd::{
+    STDERR_FILENO,
+    STDIN_FILENO,
+    STDOUT_FILENO,
+};
diff --git a/src/new/mod.rs b/src/new/mod.rs
index 2e6b451a9..869399376 100644
--- a/src/new/mod.rs
+++ b/src/new/mod.rs
@@ -168,6 +168,9 @@ cfg_if! {
     } else if #[cfg(target_env = "uclibc")] {
         mod uclibc;
         pub(crate) use uclibc::*;
+    } else if #[cfg(target_env = "mlibc")] {
+        mod mlibc;
+        pub(crate) use mlibc::*;
     }
 }
 
@@ -224,7 +227,8 @@ cfg_if! {
             target_os = "android",
             target_os = "emscripten",
             target_os = "l4re",
-            target_os = "linux"
+            target_os = "linux",
+            target_os = "managarm"
         ))]
         pub use pthread::*;
         pub use unistd::*;
-- 
2.52.0

