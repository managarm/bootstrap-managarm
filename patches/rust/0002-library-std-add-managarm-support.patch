From 985568a716d2dca78838253a492a2312136f799e Mon Sep 17 00:00:00 2001
From: Dennis Bonke <admin@dennisbonke.com>
Date: Fri, 1 Sep 2023 16:49:14 +0200
Subject: [PATCH 2/6] library/std: add managarm support

---
 library/std/build.rs               |   1 +
 library/std/src/env.rs             |   1 +
 library/std/src/os/managarm/fs.rs  | 148 +++++++++++++++++++++++++++++
 library/std/src/os/managarm/mod.rs |   6 ++
 library/std/src/os/managarm/raw.rs |  74 +++++++++++++++
 library/std/src/os/mod.rs          |   2 +
 library/std/src/os/unix/mod.rs     |   2 +
 library/std/src/sys/args/unix.rs   |   1 +
 library/std/src/sys/env_consts.rs  |  11 +++
 library/std/src/sys/fd/unix.rs     |   2 +
 library/std/src/sys/fs/unix.rs     |  15 ++-
 library/std/src/sys/pal/unix/os.rs |   2 +
 library/std/src/sys/random/mod.rs  |   1 +
 library/unwind/src/lib.rs          |   4 +
 14 files changed, 269 insertions(+), 1 deletion(-)
 create mode 100644 library/std/src/os/managarm/fs.rs
 create mode 100644 library/std/src/os/managarm/mod.rs
 create mode 100644 library/std/src/os/managarm/raw.rs

diff --git a/library/std/build.rs b/library/std/build.rs
index bee28e88..0f3b7b4b 100644
--- a/library/std/build.rs
+++ b/library/std/build.rs
@@ -54,6 +54,7 @@ fn main() {
         || target_os == "nuttx"
         || target_os == "cygwin"
         || target_os == "vexos"
+        || target_os == "managarm"
 
         // See src/bootstrap/src/core/build_steps/synthetic_targets.rs
         || env::var("RUSTC_BOOTSTRAP_SYNTHETIC_TARGET").is_ok()
diff --git a/library/std/src/env.rs b/library/std/src/env.rs
index 6d716bd8..adaee696 100644
--- a/library/std/src/env.rs
+++ b/library/std/src/env.rs
@@ -1102,6 +1102,7 @@ pub mod consts {
     /// * `"vita"`
     /// * `"vxworks"`
     /// * `"xous"`
+    /// * `"managarm"`
     ///
     /// </details>
     #[stable(feature = "env", since = "1.0.0")]
diff --git a/library/std/src/os/managarm/fs.rs b/library/std/src/os/managarm/fs.rs
new file mode 100644
index 00000000..58205f11
--- /dev/null
+++ b/library/std/src/os/managarm/fs.rs
@@ -0,0 +1,148 @@
+#![stable(feature = "metadata_ext", since = "1.1.0")]
+
+use crate::fs::Metadata;
+use crate::sys_common::AsInner;
+
+#[allow(deprecated)]
+use crate::os::managarm::raw;
+
+/// OS-specific extensions to [`fs::Metadata`].
+///
+/// [`fs::Metadata`]: crate::fs::Metadata
+#[stable(feature = "metadata_ext", since = "1.1.0")]
+pub trait MetadataExt {
+    /// Gain a reference to the underlying `stat` structure which contains
+    /// the raw information returned by the OS.
+    ///
+    /// The contents of the returned `stat` are **not** consistent across
+    /// Unix platforms. The `os::unix::fs::MetadataExt` trait contains the
+    /// cross-Unix abstractions contained within the raw stat.
+    #[stable(feature = "metadata_ext", since = "1.1.0")]
+    #[deprecated(
+        since = "1.8.0",
+        note = "deprecated in favor of the accessor \
+                  methods of this trait"
+    )]
+    #[allow(deprecated)]
+    fn as_raw_stat(&self) -> &raw::stat;
+
+    #[stable(feature = "metadata_ext2", since = "1.8.0")]
+    fn st_dev(&self) -> u64;
+
+    #[stable(feature = "metadata_ext2", since = "1.8.0")]
+    fn st_ino(&self) -> u64;
+
+    #[stable(feature = "metadata_ext2", since = "1.8.0")]
+    fn st_mode(&self) -> u32;
+
+    #[stable(feature = "metadata_ext2", since = "1.8.0")]
+    fn st_nlink(&self) -> u64;
+
+    #[stable(feature = "metadata_ext2", since = "1.8.0")]
+    fn st_uid(&self) -> u32;
+
+    #[stable(feature = "metadata_ext2", since = "1.8.0")]
+    fn st_gid(&self) -> u32;
+
+    #[stable(feature = "metadata_ext2", since = "1.8.0")]
+    fn st_rdev(&self) -> u64;
+
+    #[stable(feature = "metadata_ext2", since = "1.8.0")]
+    fn st_size(&self) -> u64;
+
+    #[stable(feature = "metadata_ext2", since = "1.8.0")]
+    fn st_atime(&self) -> i64;
+
+    #[stable(feature = "metadata_ext2", since = "1.8.0")]
+    fn st_atime_nsec(&self) -> i64;
+
+    #[stable(feature = "metadata_ext2", since = "1.8.0")]
+    fn st_mtime(&self) -> i64;
+
+    #[stable(feature = "metadata_ext2", since = "1.8.0")]
+    fn st_mtime_nsec(&self) -> i64;
+
+    #[stable(feature = "metadata_ext2", since = "1.8.0")]
+    fn st_ctime(&self) -> i64;
+
+    #[stable(feature = "metadata_ext2", since = "1.8.0")]
+    fn st_ctime_nsec(&self) -> i64;
+
+    #[stable(feature = "metadata_ext2", since = "1.8.0")]
+    fn st_blksize(&self) -> u64;
+
+    #[stable(feature = "metadata_ext2", since = "1.8.0")]
+    fn st_blocks(&self) -> u64;
+}
+
+#[stable(feature = "metadata_ext", since = "1.1.0")]
+impl MetadataExt for Metadata {
+    #[allow(deprecated)]
+    fn as_raw_stat(&self) -> &raw::stat {
+        unsafe { &*(self.as_inner().as_inner() as *const libc::stat as *const raw::stat) }
+    }
+
+    fn st_dev(&self) -> u64 {
+        self.as_inner().as_inner().st_dev as u64
+    }
+
+    fn st_ino(&self) -> u64 {
+        self.as_inner().as_inner().st_ino as u64
+    }
+
+    fn st_mode(&self) -> u32 {
+        self.as_inner().as_inner().st_mode as u32
+    }
+
+    fn st_nlink(&self) -> u64 {
+        self.as_inner().as_inner().st_nlink as u64
+    }
+
+    fn st_uid(&self) -> u32 {
+        self.as_inner().as_inner().st_uid as u32
+    }
+
+    fn st_gid(&self) -> u32 {
+        self.as_inner().as_inner().st_gid as u32
+    }
+
+    fn st_rdev(&self) -> u64 {
+        self.as_inner().as_inner().st_rdev as u64
+    }
+
+    fn st_size(&self) -> u64 {
+        self.as_inner().as_inner().st_size as u64
+    }
+
+    fn st_atime(&self) -> i64 {
+        self.as_inner().as_inner().st_atime as i64
+    }
+
+    fn st_atime_nsec(&self) -> i64 {
+        self.as_inner().as_inner().st_atime_nsec as i64
+    }
+
+    fn st_mtime(&self) -> i64 {
+        self.as_inner().as_inner().st_mtime as i64
+    }
+
+    fn st_mtime_nsec(&self) -> i64 {
+        self.as_inner().as_inner().st_mtime_nsec as i64
+    }
+
+    fn st_ctime(&self) -> i64 {
+        self.as_inner().as_inner().st_ctime as i64
+    }
+
+    fn st_ctime_nsec(&self) -> i64 {
+        self.as_inner().as_inner().st_ctime_nsec as i64
+    }
+
+    fn st_blksize(&self) -> u64 {
+        self.as_inner().as_inner().st_blksize as u64
+    }
+
+    fn st_blocks(&self) -> u64 {
+        self.as_inner().as_inner().st_blocks as u64
+    }
+}
diff --git a/library/std/src/os/managarm/mod.rs b/library/std/src/os/managarm/mod.rs
new file mode 100644
index 00000000..869966bb
--- /dev/null
+++ b/library/std/src/os/managarm/mod.rs
@@ -0,0 +1,6 @@
+//! Managarm-specific definitions
+
+#![stable(feature = "raw_ext", since = "1.1.0")]
+
+pub mod fs;
+pub mod raw;
diff --git a/library/std/src/os/managarm/raw.rs b/library/std/src/os/managarm/raw.rs
new file mode 100644
index 00000000..ce950064
--- /dev/null
+++ b/library/std/src/os/managarm/raw.rs
@@ -0,0 +1,74 @@
+#![stable(feature = "raw_ext", since = "1.1.0")]
+#![deprecated(
+    since = "1.8.0",
+    note = "these type aliases are no longer supported by \
+              the standard library, the `libc` crate on \
+              crates.io should be used instead for the correct \
+              definitions"
+)]
+#![allow(deprecated)]
+
+#[stable(feature = "pthread_t", since = "1.8.0")]
+pub type pthread_t = usize; // TODO: This is completely wrong tbh
+
+#[stable(feature = "raw_ext", since = "1.1.0")]
+pub type dev_t = libc::dev_t;
+
+#[stable(feature = "raw_ext", since = "1.1.0")]
+pub type ino_t = libc::ino_t;
+
+#[stable(feature = "raw_ext", since = "1.1.0")]
+pub type mode_t = libc::mode_t;
+
+#[stable(feature = "raw_ext", since = "1.1.0")]
+pub type nlink_t = libc::nlink_t;
+
+#[stable(feature = "raw_ext", since = "1.1.0")]
+pub type off_t = libc::off_t;
+
+#[stable(feature = "raw_ext", since = "1.1.0")]
+pub type time_t = libc::time_t;
+
+#[stable(feature = "raw_ext", since = "1.1.0")]
+pub type blkcnt_t = libc::blkcnt_t;
+
+#[stable(feature = "raw_ext", since = "1.1.0")]
+pub type blksize_t = libc::blksize_t;
+
+#[repr(C)]
+#[derive(Clone)]
+#[stable(feature = "raw_ext", since = "1.1.0")]
+pub struct stat {
+    #[stable(feature = "raw_ext", since = "1.1.0")]
+    pub st_dev: libc::dev_t,
+    #[stable(feature = "raw_ext", since = "1.1.0")]
+    pub st_ino: libc::ino_t,
+    #[stable(feature = "raw_ext", since = "1.1.0")]
+    pub st_mode: libc::mode_t,
+    #[stable(feature = "raw_ext", since = "1.1.0")]
+    pub st_nlink: libc::nlink_t,
+    #[stable(feature = "raw_ext", since = "1.1.0")]
+    pub st_uid: libc::uid_t,
+    #[stable(feature = "raw_ext", since = "1.1.0")]
+    pub st_gid: libc::gid_t,
+    #[stable(feature = "raw_ext", since = "1.1.0")]
+    pub st_rdev: libc::dev_t,
+    #[stable(feature = "raw_ext", since = "1.1.0")]
+    pub st_size: libc::off_t,
+    #[stable(feature = "raw_ext", since = "1.1.0")]
+    pub st_atime: libc::time_t,
+    #[stable(feature = "raw_ext", since = "1.1.0")]
+    pub st_atime_nsec: libc::c_long,
+    #[stable(feature = "raw_ext", since = "1.1.0")]
+    pub st_mtime: libc::time_t,
+    #[stable(feature = "raw_ext", since = "1.1.0")]
+    pub st_mtime_nsec: libc::c_long,
+    #[stable(feature = "raw_ext", since = "1.1.0")]
+    pub st_ctime: libc::time_t,
+    #[stable(feature = "raw_ext", since = "1.1.0")]
+    pub st_ctime_nsec: libc::c_long,
+    #[stable(feature = "raw_ext", since = "1.1.0")]
+    pub st_blksize: libc::blksize_t,
+    #[stable(feature = "raw_ext", since = "1.1.0")]
+    pub st_blocks: libc::blkcnt_t,
+}
diff --git a/library/std/src/os/mod.rs b/library/std/src/os/mod.rs
index 76374402..cda1f46f 100644
--- a/library/std/src/os/mod.rs
+++ b/library/std/src/os/mod.rs
@@ -155,6 +155,8 @@ pub mod windows {}
 pub mod l4re;
 #[cfg(target_os = "macos")]
 pub mod macos;
+#[cfg(target_os = "managarm")]
+pub mod managarm;
 #[cfg(target_os = "motor")]
 pub mod motor;
 #[cfg(target_os = "netbsd")]
diff --git a/library/std/src/os/unix/mod.rs b/library/std/src/os/unix/mod.rs
index 78c95727..d465c2ee 100644
--- a/library/std/src/os/unix/mod.rs
+++ b/library/std/src/os/unix/mod.rs
@@ -67,6 +67,8 @@ mod platform {
     pub use crate::os::l4re::*;
     #[cfg(target_os = "linux")]
     pub use crate::os::linux::*;
+    #[cfg(target_os = "managarm")]
+    pub use crate::os::managarm::*;
     #[cfg(target_os = "netbsd")]
     pub use crate::os::netbsd::*;
     #[cfg(target_os = "nto")]
diff --git a/library/std/src/sys/args/unix.rs b/library/std/src/sys/args/unix.rs
index 0dfbd5f0..696ebd32 100644
--- a/library/std/src/sys/args/unix.rs
+++ b/library/std/src/sys/args/unix.rs
@@ -84,6 +84,7 @@ pub fn args() -> Args {
     target_os = "hurd",
     target_os = "rtems",
     target_os = "nuttx",
+    target_os = "managarm",
 ))]
 mod imp {
     use crate::ffi::c_char;
diff --git a/library/std/src/sys/env_consts.rs b/library/std/src/sys/env_consts.rs
index 573f5404..066353b6 100644
--- a/library/std/src/sys/env_consts.rs
+++ b/library/std/src/sys/env_consts.rs
@@ -202,6 +202,17 @@ pub mod os {
     pub const EXE_EXTENSION: &str = "";
 }
 
+#[cfg(target_os = "managarm")]
+pub mod os {
+    pub const FAMILY: &str = "unix";
+    pub const OS: &str = "managarm";
+    pub const DLL_PREFIX: &str = "lib";
+    pub const DLL_SUFFIX: &str = ".so";
+    pub const DLL_EXTENSION: &str = "so";
+    pub const EXE_SUFFIX: &str = "";
+    pub const EXE_EXTENSION: &str = "";
+}
+
 #[cfg(target_os = "netbsd")]
 pub mod os {
     pub const FAMILY: &str = "unix";
diff --git a/library/std/src/sys/fd/unix.rs b/library/std/src/sys/fd/unix.rs
index 2b2dfe48..43687efa 100644
--- a/library/std/src/sys/fd/unix.rs
+++ b/library/std/src/sys/fd/unix.rs
@@ -560,6 +560,7 @@ fn pwritev(
         target_os = "redox",
         target_os = "vxworks",
         target_os = "nto",
+        target_os = "managarm",
     )))]
     pub fn set_cloexec(&self) -> io::Result<()> {
         unsafe {
@@ -583,6 +584,7 @@ pub fn set_cloexec(&self) -> io::Result<()> {
         target_os = "redox",
         target_os = "vxworks",
         target_os = "nto",
+        target_os = "managarm",
     ))]
     pub fn set_cloexec(&self) -> io::Result<()> {
         unsafe {
diff --git a/library/std/src/sys/fs/unix.rs b/library/std/src/sys/fs/unix.rs
index 3efe6739..f3a9ee2a 100644
--- a/library/std/src/sys/fs/unix.rs
+++ b/library/std/src/sys/fs/unix.rs
@@ -14,6 +14,7 @@
     target_os = "fuchsia",
     target_os = "hurd",
     target_os = "illumos",
+    target_os = "managarm"
 ))]
 use libc::dirfd;
 #[cfg(any(target_os = "fuchsia", target_os = "illumos"))]
@@ -30,6 +31,7 @@
     target_os = "redox",
     target_os = "solaris",
     target_os = "vita",
+    target_os = "managarm",
     all(target_os = "linux", target_env = "musl"),
 ))]
 use libc::readdir as readdir64;
@@ -284,6 +286,7 @@ unsafe impl Sync for Dir {}
     target_os = "redox",
     target_os = "solaris",
     target_os = "vita",
+    target_os = "managarm",
 ))]
 pub struct DirEntry {
     dir: Arc<InnerReadDir>,
@@ -309,6 +312,7 @@ pub struct DirEntry {
     target_os = "redox",
     target_os = "solaris",
     target_os = "vita",
+    target_os = "managarm",
 ))]
 struct dirent64_min {
     d_ino: u64,
@@ -334,6 +338,7 @@ struct dirent64_min {
     target_os = "redox",
     target_os = "solaris",
     target_os = "vita",
+    target_os = "managarm",
 )))]
 pub struct DirEntry {
     dir: Arc<InnerReadDir>,
@@ -714,6 +719,7 @@ impl Iterator for ReadDir {
         target_os = "redox",
         target_os = "solaris",
         target_os = "vita",
+        target_os = "managarm",
     ))]
     fn next(&mut self) -> Option<io::Result<DirEntry>> {
         use crate::sys::os::{errno, set_errno};
@@ -811,6 +817,7 @@ fn next(&mut self) -> Option<io::Result<DirEntry>> {
         target_os = "redox",
         target_os = "solaris",
         target_os = "vita",
+        target_os = "managarm",
     )))]
     fn next(&mut self) -> Option<io::Result<DirEntry>> {
         if self.end_of_stream {
@@ -999,6 +1006,7 @@ pub fn file_type(&self) -> io::Result<FileType> {
         target_os = "solaris",
         target_os = "vita",
         target_os = "vxworks",
+        target_os = "managarm",
         target_vendor = "apple",
     ))]
     pub fn ino(&self) -> u64 {
@@ -1054,6 +1062,7 @@ fn name_bytes(&self) -> &[u8] {
         target_os = "nto",
         target_os = "vita",
         target_os = "hurd",
+        target_os = "managarm",
     )))]
     fn name_cstr(&self) -> &CStr {
         unsafe { CStr::from_ptr(self.entry.d_name.as_ptr()) }
@@ -1070,6 +1079,7 @@ fn name_cstr(&self) -> &CStr {
         target_os = "nto",
         target_os = "vita",
         target_os = "hurd",
+        target_os = "managarm",
     ))]
     fn name_cstr(&self) -> &CStr {
         &self.name
@@ -1264,6 +1274,7 @@ unsafe fn os_datasync(fd: c_int) -> c_int {
             target_os = "openbsd",
             target_os = "nto",
             target_os = "hurd",
+            target_os = "managarm",
         ))]
         unsafe fn os_datasync(fd: c_int) -> c_int {
             libc::fdatasync(fd)
@@ -1278,6 +1289,7 @@ unsafe fn os_datasync(fd: c_int) -> c_int {
             target_os = "openbsd",
             target_os = "nto",
             target_os = "hurd",
+            target_os = "managarm",
             target_vendor = "apple",
         )))]
         unsafe fn os_datasync(fd: c_int) -> c_int {
@@ -1822,7 +1834,7 @@ unsafe fn from_raw_fd(raw_fd: RawFd) -> Self {
 
 impl fmt::Debug for File {
     fn fmt(&self, f: &mut fmt::Formatter<'_>) -> fmt::Result {
-        #[cfg(any(target_os = "linux", target_os = "illumos", target_os = "solaris"))]
+        #[cfg(any(target_os = "linux", target_os = "illumos", target_os = "solaris", target_os = "managarm",))]
         fn get_path(fd: c_int) -> Option<PathBuf> {
             let mut p = PathBuf::from("/proc/self/fd");
             p.push(&fd.to_string());
@@ -1884,6 +1896,7 @@ fn get_path(fd: c_int) -> Option<PathBuf> {
 
         #[cfg(not(any(
             target_os = "linux",
+            target_os = "managarm",
             target_os = "vxworks",
             target_os = "freebsd",
             target_os = "netbsd",
diff --git a/library/std/src/sys/pal/unix/os.rs b/library/std/src/sys/pal/unix/os.rs
index 7c9f3b79..9c4af731 100644
--- a/library/std/src/sys/pal/unix/os.rs
+++ b/library/std/src/sys/pal/unix/os.rs
@@ -27,6 +27,7 @@
             target_os = "fuchsia",
             target_os = "l4re",
             target_os = "hurd",
+            target_os = "managarm",
         ),
         link_name = "__errno_location"
     )]
@@ -387,6 +388,7 @@ pub fn current_exe() -> io::Result<PathBuf> {
     target_os = "hurd",
     target_os = "android",
     target_os = "nuttx",
+    target_os = "managarm",
     target_os = "emscripten"
 ))]
 pub fn current_exe() -> io::Result<PathBuf> {
diff --git a/library/std/src/sys/random/mod.rs b/library/std/src/sys/random/mod.rs
index 91f72d07..5e703013 100644
--- a/library/std/src/sys/random/mod.rs
+++ b/library/std/src/sys/random/mod.rs
@@ -54,6 +54,7 @@
         target_os = "hurd",
         target_os = "l4re",
         target_os = "nto",
+        target_os = "managarm",
     ) => {
         mod unix_legacy;
         pub use unix_legacy::fill_bytes;
diff --git a/library/unwind/src/lib.rs b/library/unwind/src/lib.rs
index cd3a2f33..759be752 100644
--- a/library/unwind/src/lib.rs
+++ b/library/unwind/src/lib.rs
@@ -197,3 +197,7 @@
 #[link(name = "unwind", kind = "static", modifiers = "-bundle", cfg(target_feature = "crt-static"))]
 #[link(name = "unwind", cfg(not(target_feature = "crt-static")))]
 unsafe extern "C" {}
+
+#[cfg(target_os = "managarm")]
+#[link(name = "gcc_s")]
+unsafe extern "C" {}
-- 
2.52.0

