From 131a7688e445ca28cb90aa582f7a93fe7e02bc02 Mon Sep 17 00:00:00 2001
From: ikbenlike <thewatcheriswatchinu@gmail.com>
Date: Thu, 17 Apr 2025 00:09:38 +0200
Subject: [PATCH] patch in managarm specific compile needs

---
 lib/fuse_i.h           | 1 +
 lib/meson.build        | 2 +-
 util/fusermount.c      | 2 ++
 util/install_helper.sh | 2 --
 util/mount.fuse.c      | 4 ++--
 5 files changed, 6 insertions(+), 5 deletions(-)

diff --git a/lib/fuse_i.h b/lib/fuse_i.h
index 6fbfc2d..6f78b84 100644
--- a/lib/fuse_i.h
+++ b/lib/fuse_i.h
@@ -13,6 +13,7 @@
 #include <stdint.h>
 #include <stdbool.h>
 #include <errno.h>
+#include <pthread.h>
 
 #define MIN(a, b) \
 ({									\
diff --git a/lib/meson.build b/lib/meson.build
index 6a52d06..1ae6f85 100644
--- a/lib/meson.build
+++ b/lib/meson.build
@@ -4,7 +4,7 @@ libfuse_sources = ['fuse.c', 'fuse_i.h', 'fuse_loop.c', 'fuse_loop_mt.c',
                    'helper.c', 'modules/subdir.c', 'mount_util.c',
                    'fuse_log.c', 'compat.c', 'util.c', 'util.h' ]
 
-if host_machine.system().startswith('linux')
+if host_machine.system().startswith('linux') or host_machine.system().startswith('managarm')
    libfuse_sources += [ 'mount.c' ]
 else
    libfuse_sources += [ 'mount_bsd.c' ]
diff --git a/util/fusermount.c b/util/fusermount.c
index dbd947c..ee1796c 100644
--- a/util/fusermount.c
+++ b/util/fusermount.c
@@ -36,6 +36,8 @@
 #include <stdbool.h>
 #include <sys/vfs.h>
 
+#include <signal.h>
+
 #ifdef HAVE_CLOSE_RANGE
 #include <linux/close_range.h>
 #endif
diff --git a/util/install_helper.sh b/util/install_helper.sh
index 76f2b47..fab3b78 100755
--- a/util/install_helper.sh
+++ b/util/install_helper.sh
@@ -28,12 +28,10 @@ install -D -m 644 "${MESON_SOURCE_ROOT}/util/fuse.conf" \
 	"${DESTDIR}${sysconfdir}/fuse.conf"
 
 if $useroot; then
-    chown root:root "${DESTDIR}${bindir}/fusermount3"
     chmod u+s "${DESTDIR}${bindir}/fusermount3"
 
     if test ! -e "${DESTDIR}/dev/fuse"; then
         mkdir -p "${DESTDIR}/dev"
-        mknod "${DESTDIR}/dev/fuse" -m 0666 c 10 229
     fi
 fi
 
diff --git a/util/mount.fuse.c b/util/mount.fuse.c
index b98fb2a..0b6f1b7 100644
--- a/util/mount.fuse.c
+++ b/util/mount.fuse.c
@@ -350,7 +350,7 @@ int main(int argc, char *argv[])
 			free(opts);
 		}
 	}
-
+#ifndef __managarm__
 	if (drop_privileges) {
 		uint64_t required_caps = CAP_TO_MASK(CAP_SETPCAP) |
 				CAP_TO_MASK(CAP_SYS_ADMIN);
@@ -360,7 +360,7 @@ int main(int argc, char *argv[])
 			exit(1);
 		}
 	}
-
+#endif /* if defined(__managarm__) */
 	if (dev)
 		options = add_option("dev", options);
 	if (suid)
-- 
2.49.0

