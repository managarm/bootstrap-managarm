From fd010ca74eacde2759e1350b4284212781bac7f7 Mon Sep 17 00:00:00 2001
From: Dennis Bonke <admin@dennisbonke.com>
Date: Sun, 10 Aug 2025 15:03:10 +0200
Subject: [PATCH 5/5] Managarm: Define __mlibc__ and fix ld.so paths

---
 clang/lib/Basic/Targets/OSTargets.h      |  1 +
 clang/lib/Driver/ToolChains/Managarm.cpp | 10 ++++------
 clang/test/Driver/managarm.cpp           |  4 ++--
 3 files changed, 7 insertions(+), 8 deletions(-)

diff --git a/clang/lib/Basic/Targets/OSTargets.h b/clang/lib/Basic/Targets/OSTargets.h
index 257d399b2..88adf8575 100644
--- a/clang/lib/Basic/Targets/OSTargets.h
+++ b/clang/lib/Basic/Targets/OSTargets.h
@@ -381,6 +381,7 @@ protected:
                     MacroBuilder &Builder) const override {
     DefineStd(Builder, "unix", Opts);
     Builder.defineMacro("__managarm__");
+    Builder.defineMacro("__mlibc__");
     if (Opts.POSIXThreads)
       Builder.defineMacro("_REENTRANT");
     if (Opts.CPlusPlus)
diff --git a/clang/lib/Driver/ToolChains/Managarm.cpp b/clang/lib/Driver/ToolChains/Managarm.cpp
index 51abd8459..0764503dc 100644
--- a/clang/lib/Driver/ToolChains/Managarm.cpp
+++ b/clang/lib/Driver/ToolChains/Managarm.cpp
@@ -126,13 +126,11 @@ std::string Managarm::computeSysRoot() const {
 std::string Managarm::getDynamicLinker(const ArgList &Args) const {
   switch (getTriple().getArch()) {
   case llvm::Triple::aarch64:
-    return "/lib/aarch64-managarm/ld.so";
-  case llvm::Triple::riscv64: {
-    StringRef ABIName = tools::riscv::getRISCVABI(Args, getTriple());
-    return ("/lib/riscv64-managarm/ld-riscv64-" + ABIName + ".so").str();
-  }
+    return "/lib/aarch64-managarm-mlibc-ld.so";
+  case llvm::Triple::riscv64:
+    return "/lib/riscv64-managarm-mlibc-ld.so";
   case llvm::Triple::x86_64:
-    return "/lib/x86_64-managarm/ld.so";
+    return "/lib/x86_64-managarm-mlibc-ld.so";
   default:
     llvm_unreachable("unsupported architecture");
   }
diff --git a/clang/test/Driver/managarm.cpp b/clang/test/Driver/managarm.cpp
index 86f1e2710..3cbeba312 100644
--- a/clang/test/Driver/managarm.cpp
+++ b/clang/test/Driver/managarm.cpp
@@ -13,7 +13,7 @@
 // CHECK-X86-64-SAME: {{^}} "-internal-externc-isystem" "[[SYSROOT]]/include"
 // CHECK-X86-64-SAME: {{^}} "-internal-externc-isystem" "[[SYSROOT]]/usr/include"
 // CHECK-X86-64:      "{{.*}}ld" "--sysroot=[[SYSROOT:[^"]+]]"
-// CHECK-X86-64-SAME: "-dynamic-linker" "/lib/x86_64-managarm/ld.so"
+// CHECK-X86-64-SAME: "-dynamic-linker" "/lib/x86_64-managarm-mlibc-ld.so"
 // CHECK-X86-64-SAME: "{{.*}}/usr/lib/gcc/x86_64-managarm-mlibc/10/crtbegin.o"
 // CHECK-X86-64-SAME: "-L
 // CHECK-X86-64-SAME: {{^}}[[SYSROOT]]/usr/lib/gcc/x86_64-managarm-mlibc/10"
@@ -78,7 +78,7 @@
 // CHECK-AARCH64-SAME: {{^}} "-internal-externc-isystem" "[[SYSROOT]]/include"
 // CHECK-AARCH64-SAME: {{^}} "-internal-externc-isystem" "[[SYSROOT]]/usr/include"
 // CHECK-AARCH64:      "{{.*}}ld" "--sysroot=[[SYSROOT:[^"]+]]"
-// CHECK-AARCH64-SAME: "-dynamic-linker" "/lib/aarch64-managarm/ld.so"
+// CHECK-AARCH64-SAME: "-dynamic-linker" "/lib/aarch64-managarm-mlibc-ld.so"
 // CHECK-AARCH64-SAME: "{{.*}}/usr/lib/gcc/aarch64-managarm-mlibc/10/crtbegin.o"
 // CHECK-AARCH64-SAME: "-L
 // CHECK-AARCH64-SAME: {{^}}[[SYSROOT]]/usr/lib/gcc/aarch64-managarm-mlibc/10"
-- 
2.50.1

